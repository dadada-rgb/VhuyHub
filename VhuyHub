local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Lighting = game:GetService("Lighting")

-- Cấu hình
local Config = {
    ESPEnabled = false,
    FullbrightEnabled = false,
    NoclipEnabled = false,
    WalkSpeed = 16,
    JumpPower = 50,
    FlyEnabled = false,
    FlySpeed = 50
}

-- Biến lưu trạng thái Lighting cũ cho Fullbright
local oldLighting = {
    Brightness = Lighting.Brightness,
    GlobalShadows = Lighting.GlobalShadows,
    FogEnd = Lighting.FogEnd,
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    ClockTime = Lighting.ClockTime
}

-- Kết nối cho Noclip
local noclipConnection = nil

local TweenService = game:GetService("TweenService")
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- ===== ScreenGui chính =====
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = tostring(math.random(1e6, 1e7))
ScreenGui.ResetOnSpawn = false
ScreenGui.Enabled = true
ScreenGui.Parent = PlayerGui

-- ===== Frame chính =====
local MenuFrame = Instance.new("Frame")
MenuFrame.Size = UDim2.new(0, 270, 0, 220)
MenuFrame.Position = UDim2.new(0.05, 0, 0.25, 0)
MenuFrame.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
MenuFrame.Active = true
MenuFrame.Draggable = true
MenuFrame.Parent = ScreenGui
Instance.new("UICorner", MenuFrame).CornerRadius = UDim.new(0, 10)

-- Gradient nền
local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 200, 200)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 150, 150))
}
gradient.Rotation = 90
gradient.Parent = MenuFrame

-- Viền
local stroke = Instance.new("UIStroke")
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(255, 255, 255)
stroke.Parent = MenuFrame

-- ===== Nút Toggle Show/Hide =====
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 60, 0, 25)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
ToggleButton.Text = "SHOW"
ToggleButton.TextColor3 = Color3.new(0, 0, 0)
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.TextSize = 14
ToggleButton.Active = true
ToggleButton.Draggable = true
ToggleButton.Parent = ScreenGui
Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 8)

-- Hover/click animation
local function AnimateButton(btn)
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(255, 200, 200)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(255, 179, 186)}):Play()
    end)
    btn.MouseButton1Click:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.1), {Size = btn.Size + UDim2.new(0, 2, 0, 2)}):Play()
        task.wait(0.1)
        TweenService:Create(btn, TweenInfo.new(0.1), {Size = btn.Size - UDim2.new(0, 2, 0, 2)}):Play()
    end)
end
AnimateButton(ToggleButton)

-- Show/hide với tween
ToggleButton.MouseButton1Click:Connect(function()
    local targetSize = MenuFrame.Visible and UDim2.new(0, 0, 0, 0) or UDim2.new(0, 270, 0, 220)
    local tween = TweenService:Create(MenuFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = targetSize})
    if not MenuFrame.Visible then
        MenuFrame.Visible = true
        tween:Play()
    else
        tween:Play()
        tween.Completed:Wait()
        MenuFrame.Visible = false
    end
    ToggleButton.Text = MenuFrame.Visible and "HIDE" or "SHOW"
end)

-- ===== Tiêu đề & Clock =====
local MenuTitle = Instance.new("TextLabel")
MenuTitle.Size = UDim2.new(1, 0, 0, 25)
MenuTitle.BackgroundTransparency = 1
MenuTitle.Text = "DhuyxDTuyen"
MenuTitle.TextColor3 = Color3.new(0, 0, 0)
MenuTitle.Font = Enum.Font.SourceSansBold
MenuTitle.TextSize = 16
MenuTitle.Parent = MenuFrame

-- Khung giờ
local Clock = Instance.new("TextLabel")
Clock.Size = UDim2.new(0, 100, 0, 20)
Clock.Position = UDim2.new(1, -105, 0, 2)
Clock.BackgroundTransparency = 1
Clock.TextColor3 = Color3.new(0, 0, 0)
Clock.Font = Enum.Font.SourceSans
Clock.TextSize = 14
Clock.TextXAlignment = Enum.TextXAlignment.Right
Clock.Parent = MenuTitle

-- Update giờ
task.spawn(function()
    while task.wait(1) do
        local timeStr = os.date("%H:%M:%S")
        Clock.Text = string.format("Time: %s", timeStr)
    end
end)

-- Frame sliders (bên trái)
local SliderFrame = Instance.new("Frame")
SliderFrame.Size = UDim2.new(0.5, -5, 1, -25)
SliderFrame.Position = UDim2.new(0, 5, 0, 20)
SliderFrame.BackgroundTransparency = 1
SliderFrame.Parent = MenuFrame

local SliderLayout = Instance.new("UIListLayout")
SliderLayout.SortOrder = Enum.SortOrder.LayoutOrder
SliderLayout.Padding = UDim.new(0, 10)
SliderLayout.Parent = SliderFrame

-- Hàm tạo slider
local function CreateSlider(name, min, max, default, callback)
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(1, 0, 0, 30)
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Parent = SliderFrame

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 15)
    label.BackgroundTransparency = 1
    label.Text = name .. ": " .. default
    label.TextColor3 = Color3.new(0, 0, 0)
    label.TextSize = 12
    label.Parent = sliderFrame

    local track = Instance.new("Frame")
    track.Size = UDim2.new(1, 0, 0, 5)
    track.Position = UDim2.new(0, 0, 0.5, 0)
    track.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
    track.Parent = sliderFrame
    Instance.new("UICorner", track).CornerRadius = UDim.new(0, 3)

    local knob = Instance.new("TextButton")
    knob.Size = UDim2.new(0, 10, 0, 15)
    knob.Position = UDim2.new((default - min) / (max - min), -5, 0.25, -2.5)
    knob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    knob.Text = ""
    knob.Parent = sliderFrame
    Instance.new("UICorner", knob).CornerRadius = UDim.new(0, 5)

    local dragging = false
    knob.MouseButton1Down:Connect(function()
        dragging = true
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local pos = math.clamp((input.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X, 0, 1)
            knob.Position = UDim2.new(pos, -5, knob.Position.Y.Scale, knob.Position.Y.Offset)
            local value = math.floor(min + pos * (max - min))
            label.Text = name .. ": " .. value
            callback(value)
        end
    end)
    return sliderFrame
end

-- Slider WalkSpeed
CreateSlider("WalkSpeed", 1, 300, Config.WalkSpeed, function(value)
    Config.WalkSpeed = value
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = value
    end
end)

-- Slider JumpPower
CreateSlider("JumpPower", 1, 600, Config.JumpPower, function(value)
    Config.JumpPower = value
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.UseJumpPower = true
        LocalPlayer.Character.Humanoid.JumpPower = value
    end
end)

-- Slider FlySpeed
CreateSlider("FlySpeed", 1, 400, Config.FlySpeed, function(value)
    Config.FlySpeed = value
end)

-- Frame nút chức năng (bên phải)
local ButtonFrame = Instance.new("ScrollingFrame")
ButtonFrame.Size = UDim2.new(0.5, -5, 1, -25)
ButtonFrame.Position = UDim2.new(0.5, 0, 0, 20)
ButtonFrame.BackgroundTransparency = 1
ButtonFrame.ScrollBarThickness = 3
ButtonFrame.CanvasSize = UDim2.new(0, 0, 0, 0) -- Will be updated dynamically
ButtonFrame.Parent = MenuFrame

local ButtonLayout = Instance.new("UIListLayout")
ButtonLayout.SortOrder = Enum.SortOrder.LayoutOrder
ButtonLayout.Padding = UDim.new(0, 5)
ButtonLayout.Parent = ButtonFrame

-- Update CanvasSize dynamically based on button count
ButtonLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ButtonFrame.CanvasSize = UDim2.new(0, 0, 0, ButtonLayout.AbsoluteContentSize.Y)
end)

-- Hàm tạo nút
local function CreateButton(name, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, -10, 0, 25)
    button.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    button.BackgroundTransparency = 0.2
    button.TextColor3 = Color3.fromRGB(0, 0, 0)
    button.TextSize = 12
    button.Font = Enum.Font.SourceSans
    button.Text = name
    button.Parent = ButtonFrame
    button.MouseButton1Click:Connect(callback)
    Instance.new("UICorner", button).CornerRadius = UDim.new(0, 4)
    return button
end

local function UpdateButtonText()
    espButton.Text = "ESP: " .. (Config.ESPEnabled and "ON" or "OFF")
    fullbrightButton.Text = "Fullbright: " .. (Config.FullbrightEnabled and "ON" or "OFF")
    noclipButton.Text = "Noclip: " .. (Config.NoclipEnabled and "ON" or "OFF")
    flyButton.Text = "Fly: " .. (Config.FlyEnabled and "ON" or "OFF")
end

espButton = CreateButton("ESP: OFF", function()
    Config.ESPEnabled = not Config.ESPEnabled
    UpdateButtonText()
end)

fullbrightButton = CreateButton("Fullbright: OFF", function()
    Config.FullbrightEnabled = not Config.FullbrightEnabled
    if Config.FullbrightEnabled then
        Lighting.Brightness = 2
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 999999
        Lighting.Ambient = Color3.fromRGB(255, 255, 255)
        Lighting.OutdoorAmbient = Color3.fromRGB(255, 255, 255)
        Lighting.ClockTime = 12
    else
        Lighting.Brightness = oldLighting.Brightness
        Lighting.GlobalShadows = oldLighting.GlobalShadows
        Lighting.FogEnd = oldLighting.FogEnd
        Lighting.Ambient = oldLighting.Ambient
        Lighting.OutdoorAmbient = oldLighting.OutdoorAmbient
        Lighting.ClockTime = oldLighting.ClockTime
    end
    UpdateButtonText()
end)

noclipButton = CreateButton("Noclip: OFF", function()
    Config.NoclipEnabled = not Config.NoclipEnabled
    if Config.NoclipEnabled then
        if noclipConnection then noclipConnection:Disconnect() end
        noclipConnection = RunService.Stepped:Connect(function()
            local character = LocalPlayer.Character
            if character then
                for _, part in pairs(character:GetDescendants()) do
                    if part:IsA("BasePart") and part.CanCollide then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
        local character = LocalPlayer.Character
        if character then
            for _, part in pairs(character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end
    end
    UpdateButtonText()
end)

LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    if Config.NoclipEnabled then
        Config.NoclipEnabled = false
        wait(0.5)
        Config.NoclipEnabled = true
        noclipButton:MouseButton1Click()
    end
end)

flyButton = CreateButton("Fly: OFF", function()
    Config.FlyEnabled = not Config.FlyEnabled
    UpdateButtonText()
end)

-- === TẠO 3 TRANG ===
local currentPage = 1

-- Frame Trang 1 (hiện nội dung gốc)
local Page1 = Instance.new("Frame")
Page1.Size = UDim2.new(1, 0, 1, -30)
Page1.Position = UDim2.new(0, 0, 0, 0)
Page1.BackgroundTransparency = 1
Page1.Parent = MenuFrame

-- Chuyển toàn bộ SliderFrame và ButtonFrame vào Page1
SliderFrame.Parent = Page1
ButtonFrame.Parent = Page1

-- Frame Trang 2 (executor)
local Page2 = Instance.new("Frame")
Page2.Size = UDim2.new(1, 0, 1, -30)
Page2.Position = UDim2.new(0, 0, 0, 0)
Page2.BackgroundTransparency = 1
Page2.Visible = false
Page2.Parent = MenuFrame

-- ScrollingFrame chứa CodeBox
local CodeScroll = Instance.new("ScrollingFrame")
CodeScroll.Size = UDim2.new(1, -10, 1, -70)
CodeScroll.Position = UDim2.new(0, 5, 0, 35)
CodeScroll.BackgroundTransparency = 0.2
CodeScroll.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
CodeScroll.ScrollBarThickness = 6
CodeScroll.ScrollingDirection = Enum.ScrollingDirection.XY
CodeScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
CodeScroll.ScrollBarImageTransparency = 0
CodeScroll.Parent = Page2
Instance.new("UICorner", CodeScroll).CornerRadius = UDim.new(0, 4)

-- TextBox chứa code
local CodeBox = Instance.new("TextBox")
CodeBox.Size = UDim2.new(0, 1000, 0, 1000)
CodeBox.Position = UDim2.new(0, 5, 0, 5)
CodeBox.MultiLine = true
CodeBox.ClearTextOnFocus = false
CodeBox.TextWrapped = false
CodeBox.TextYAlignment = Enum.TextYAlignment.Top
CodeBox.TextXAlignment = Enum.TextXAlignment.Left
CodeBox.BackgroundTransparency = 1
CodeBox.Font = Enum.Font.Code
CodeBox.TextSize = 14
CodeBox.TextColor3 = Color3.fromRGB(0, 0, 0)
CodeBox.Text = "-- Nhập script của bạn vào đây --"
CodeBox.Parent = CodeScroll

-- Cập nhật CanvasSize động cho CodeScroll
local TextService = game:GetService("TextService")
CodeBox:GetPropertyChangedSignal("Text"):Connect(function()
    local textBounds = TextService:GetTextSize(
        CodeBox.Text,
        CodeBox.TextSize,
        CodeBox.Font,
        Vector2.new(1000, 1000)
    )
    CodeScroll.CanvasSize = UDim2.new(0, math.max(textBounds.X + 30, CodeScroll.AbsoluteSize.X), 0, math.max(textBounds.Y + 30, CodeScroll.AbsoluteSize.Y))
end)

-- Kích hoạt CanvasSize ban đầu
local initialTextBounds = TextService:GetTextSize(
    CodeBox.Text,
    CodeBox.TextSize,
    CodeBox.Font,
    Vector2.new(1000, 1000)
)
CodeScroll.CanvasSize = UDim2.new(0, math.max(initialTextBounds.X + 30, CodeScroll.AbsoluteSize.X), 0, math.max(initialTextBounds.Y + 30, CodeScroll.AbsoluteSize.Y))

-- Nút Execute
local ExecuteBtn = Instance.new("TextButton")
ExecuteBtn.Size = UDim2.new(0.5, -7, 0, 30)
ExecuteBtn.Position = UDim2.new(0, 5, 1, -35)
ExecuteBtn.BackgroundColor3 = Color3.fromRGB(150, 255, 150)
ExecuteBtn.Text = "Execute"
ExecuteBtn.Font = Enum.Font.SourceSansBold
ExecuteBtn.TextSize = 14
ExecuteBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
Instance.new("UICorner", ExecuteBtn).CornerRadius = UDim.new(0, 4)
ExecuteBtn.Parent = Page2

ExecuteBtn.MouseButton1Click:Connect(function()
    local code = CodeBox.Text
    if code and code ~= "" then
        local func, err = loadstring(code)
        if func then
            pcall(func)
        else
            warn("Lỗi script:", err)
        end
    end
end)

-- Nút Clear
local ClearBtn = Instance.new("TextButton")
ClearBtn.Size = UDim2.new(0.5, -7, 0, 30)
ClearBtn.Position = UDim2.new(0.5, 2, 1, -35)
ClearBtn.BackgroundColor3 = Color3.fromRGB(255, 150, 150)
ClearBtn.Text = "Clear"
ClearBtn.Font = Enum.Font.SourceSansBold
ClearBtn.TextSize = 14
ClearBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
Instance.new("UICorner", ClearBtn).CornerRadius = UDim.new(0, 4)
ClearBtn.Parent = Page2

ClearBtn.MouseButton1Click:Connect(function()
    CodeBox.Text = ""
end)

-- Frame Trang 3 (script hub)
local Page3 = Instance.new("Frame")
Page3.Size = UDim2.new(1, 0, 1, -30)
Page3.Position = UDim2.new(0, 0, 0, 0)
Page3.BackgroundTransparency = 1
Page3.Visible = false
Page3.Parent = MenuFrame

-- ScrollingFrame cho Trang 3
local ScriptHubScroll = Instance.new("ScrollingFrame")
ScriptHubScroll.Size = UDim2.new(1, -10, 1, -70)
ScriptHubScroll.Position = UDim2.new(0, 5, 0, 35)
ScriptHubScroll.BackgroundTransparency = 1
ScriptHubScroll.ScrollBarThickness = 6
ScriptHubScroll.ScrollingDirection = Enum.ScrollingDirection.XY
ScriptHubScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
ScriptHubScroll.ScrollBarImageTransparency = 0
ScriptHubScroll.Parent = Page3

local ScriptListLayout = Instance.new("UIListLayout")
ScriptListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ScriptListLayout.Padding = UDim.new(0, 5)
ScriptListLayout.FillDirection = Enum.FillDirection.Vertical
ScriptListLayout.Parent = ScriptHubScroll

-- Cập nhật CanvasSize động cho ScriptHubScroll
ScriptListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScriptHubScroll.CanvasSize = UDim2.new(0, ScriptListLayout.AbsoluteContentSize.X, 0, ScriptListLayout.AbsoluteContentSize.Y)
end)

-- Hàm tạo item script hub
local function CreateScriptItem(name, url)
    local itemFrame = Instance.new("Frame")
    itemFrame.Size = UDim2.new(1, 0, 0, 30)
    itemFrame.BackgroundTransparency = 0.2
    itemFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    itemFrame.Parent = ScriptHubScroll
    Instance.new("UICorner", itemFrame).CornerRadius = UDim.new(0, 4)

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(0.7, 0, 1, 0)
    nameLabel.Position = UDim2.new(0, 5, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = name
    nameLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextSize = 14
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = itemFrame

    local runBtn = Instance.new("TextButton")
    runBtn.Size = UDim2.new(0.3, -10, 1, -4)
    runBtn.Position = UDim2.new(0.7, 5, 0, 2)
    runBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
    runBtn.Text = "Run"
    runBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
    runBtn.TextSize = 14
    runBtn.Font = Enum.Font.SourceSansBold
    runBtn.Parent = itemFrame
    Instance.new("UICorner", runBtn).CornerRadius = UDim.new(0, 4)

    runBtn.MouseButton1Click:Connect(function()
        loadstring(game:HttpGet(url))()
    end)

    return itemFrame
end

-- Tạo các script item
CreateScriptItem("Evade", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/evade")
CreateScriptItem("Murder Mystery 2", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/mm2")
CreateScriptItem("Blade Ball", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/Bladeball")
CreateScriptItem("Doors", "https://raw.githubusercontent.com/DarkDoorsKing/Project/main/Doors.lua")

-- Thanh chuyển trang
local PageButtons = Instance.new("Frame")
PageButtons.Size = UDim2.new(1, 0, 0, 30)
PageButtons.Position = UDim2.new(0, 0, 1, -30)
PageButtons.BackgroundTransparency = 1
PageButtons.Parent = MenuFrame

local Btn1 = Instance.new("TextButton")
Btn1.Size = UDim2.new(1/3, -2, 1, 0)
Btn1.Position = UDim2.new(0, 0, 0, 0)
Btn1.Text = "Trang 1"
Btn1.BackgroundColor3 = Color3.fromRGB(200, 200, 255)
Instance.new("UICorner", Btn1).CornerRadius = UDim.new(0, 4)
Btn1.Parent = PageButtons

local Btn2 = Instance.new("TextButton")
Btn2.Size = UDim2.new(1/3, -2, 1, 0)
Btn2.Position = UDim2.new(1/3, 2, 0, 0)
Btn2.Text = "Trang 2"
Btn2.BackgroundColor3 = Color3.fromRGB(200, 255, 200)
Instance.new("UICorner", Btn2).CornerRadius = UDim.new(0, 4)
Btn2.Parent = PageButtons

local Btn3 = Instance.new("TextButton")
Btn3.Size = UDim2.new(1/3, -2, 1, 0)
Btn3.Position = UDim2.new(2/3, 2, 0, 0)
Btn3.Text = "Trang 3"
Btn3.BackgroundColor3 = Color3.fromRGB(255, 200, 200)
Instance.new("UICorner", Btn3).CornerRadius = UDim.new(0, 4)
Btn3.Parent = PageButtons

-- Sự kiện chuyển trang
local function ShowPage(page)
    Page1.Visible = (page == 1)
    Page2.Visible = (page == 2)
    Page3.Visible = (page == 3)
end

Btn1.MouseButton1Click:Connect(function()
    ShowPage(1)
end)

Btn2.MouseButton1Click:Connect(function()
    ShowPage(2)
end)

Btn3.MouseButton1Click:Connect(function()
    ShowPage(3)
end)

-- Đặt BackgroundTransparency của MenuFrame = 0
MenuFrame.BackgroundTransparency = 0

-- Khởi tạo ScreenGui cho ESP
local espGui = Instance.new("ScreenGui")
espGui.Name = "SafeESP"
espGui.ResetOnSpawn = false
espGui.IgnoreGuiInset = true
espGui.Parent = PlayerGui

-- Danh sách ESP
local ESPs = {}

-- Kiểm tra trạng thái người chơi
local function IsValidTarget(player)
    if not player or not player.Character or not player.Character:FindFirstChild("Humanoid") or not player.Character:FindFirstChild("HumanoidRootPart") then return false end
    local bodyEffects = player.Character:FindFirstChild("BodyEffects")
    local isKO = bodyEffects and bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
    local isGrabbed = player.Character:FindFirstChild("GRABBING_CONSTRAINT") ~= nil
    return not (isKO or isGrabbed)
end

-- Tạo ESP
local function CreateESP(player)
    if ESPs[player] or player == LocalPlayer then return end
    local label = Instance.new("TextLabel")
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.Font = Enum.Font.GothamBlack
    label.Text = player.DisplayName
    label.TextStrokeTransparency = 0.7
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    label.Size = UDim2.new(0, 200, 0, 20)
    label.AnchorPoint = Vector2.new(0.5, 0.5)
    label.Position = UDim2.new(0.5, 0, 0.5, 0)
    label.Visible = false
    label.Parent = espGui

    local highlight = Instance.new("Highlight")
    highlight.Enabled = false
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0.3
    highlight.FillColor = Color3.fromRGB(255, 255, 255)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.Adornee = player.Character
    highlight.Parent = espGui

    ESPs[player] = { label = label, highlight = highlight }
end

-- Xóa ESP
local function RemoveESP(player)
    if ESPs[player] then
        pcall(function()
            ESPs[player].label:Destroy()
            ESPs[player].highlight:Destroy()
        end)
        ESPs[player] = nil
    end
end

-- Cập nhật ESP
local function UpdateESP()
    if not Config.ESPEnabled then
        for _, v in pairs(ESPs) do
            v.label.Visible = false
            v.highlight.Enabled = false
        end
        return
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and IsValidTarget(player) then
            local character = player.Character
            local head = character:FindFirstChild("Head")
            if head then
                CreateESP(player)
                local headPos = head.Position
                local screenPos, onScreen = Camera:WorldToViewportPoint(headPos)
                local esp = ESPs[player]
                if esp then
                    if onScreen then
                        esp.label.Visible = true
                        esp.label.Position = UDim2.new(0, screenPos.X, 0, screenPos.Y - 20)
                        esp.highlight.Enabled = true
                    else
                        esp.label.Visible = false
                        esp.highlight.Enabled = false
                    end
                end
            else
                RemoveESP(player)
            end
        else
            RemoveESP(player)
        end
    end
end

-- Fly logic supporting PC and Mobile
local flyBv, flyBg
local flyKeys = {w = false, s = false, a = false, d = false, space = false, ctrl = false}

local function startFly()
    local character = LocalPlayer.Character
    if not character then return end
    local humanoid = character:FindFirstChild("Humanoid")
    local root = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not root then return end

    humanoid.PlatformStand = true
    flyBv = Instance.new("BodyVelocity")
    flyBv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    flyBv.Velocity = Vector3.new(0, 0, 0)
    flyBv.Parent = root

    flyBg = Instance.new("BodyGyro")
    flyBg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    flyBg.P = 9e4
    flyBg.Parent = root

    spawn(function()
        while Config.FlyEnabled do
            local cam = Workspace.CurrentCamera
            local dir = Vector3.new(0, 0, 0)
            if flyKeys.w then dir = dir + cam.CFrame.LookVector end
            if flyKeys.s then dir = dir - cam.CFrame.LookVector end
            if flyKeys.a then dir = dir - cam.CFrame.RightVector end
            if flyKeys.d then dir = dir + cam.CFrame.RightVector end
            if flyKeys.space then dir = dir + Vector3.new(0, 1, 0) end
            if flyKeys.ctrl then dir = dir - Vector3.new(0, 1, 0) end
            if dir.Magnitude > 0 then dir = dir.Unit end
            flyBv.Velocity = dir * Config.FlySpeed
            flyBg.CFrame = cam.CFrame
            RunService.RenderStepped:Wait()
        end
        humanoid.PlatformStand = false
        if flyBv then flyBv:Destroy() end
        if flyBg then flyBg:Destroy() end
    end)
end

UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.W then flyKeys.w = true
    elseif input.KeyCode == Enum.KeyCode.S then flyKeys.s = true
    elseif input.KeyCode == Enum.KeyCode.A then flyKeys.a = true
    elseif input.KeyCode == Enum.KeyCode.D then flyKeys.d = true
    elseif input.KeyCode == Enum.KeyCode.Space then flyKeys.space = true
    elseif input.KeyCode == Enum.KeyCode.LeftControl then flyKeys.ctrl = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.W then flyKeys.w = false
    elseif input.KeyCode == Enum.KeyCode.S then flyKeys.s = false
    elseif input.KeyCode == Enum.KeyCode.A then flyKeys.a = false
    elseif input.KeyCode == Enum.KeyCode.D then flyKeys.d = false
    elseif input.KeyCode == Enum.KeyCode.Space then flyKeys.space = false
    elseif input.KeyCode == Enum.KeyCode.LeftControl then flyKeys.ctrl = false
    end
end)

-- For mobile support, add on-screen buttons when fly enabled
local flyControlsGui
if UserInputService.TouchEnabled then
    flyControlsGui = Instance.new("ScreenGui")
    flyControlsGui.Parent = PlayerGui

    local function createFlyButton(name, pos, key)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, 50, 0, 50)
        btn.Position = pos
        btn.Text = name
        btn.Parent = flyControlsGui
        btn.Visible = false
        btn.MouseButton1Down:Connect(function()
            flyKeys[key] = true
        end)
        btn.MouseButton1Up:Connect(function()
            flyKeys[key] = false
        end)
        return btn
    end

    local wBtn = createFlyButton("W", UDim2.new(0.4, 0, 0.8, 0), "w")
    local sBtn = createFlyButton("S", UDim2.new(0.4, 0, 0.9, 0), "s")
    local aBtn = createFlyButton("A", UDim2.new(0.3, 0, 0.85, 0), "a")
    local dBtn = createFlyButton("D", UDim2.new(0.5, 0, 0.85, 0), "d")
    local upBtn = createFlyButton("Up", UDim2.new(0.6, 0, 0.8, 0), "space")
    local downBtn = createFlyButton("Down", UDim2.new(0.6, 0, 0.9, 0), "ctrl")

    local function toggleFlyButtons(visible)
        wBtn.Visible = visible
        sBtn.Visible = visible
        aBtn.Visible = visible
        dBtn.Visible = visible
        upBtn.Visible = visible
        downBtn.Visible = visible
    end

    flyButton.MouseButton1Click:Connect(function()
        toggleFlyButtons(Config.FlyEnabled)
    end)
end

LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("Humanoid").WalkSpeed = Config.WalkSpeed
    char:WaitForChild("Humanoid").JumpPower = Config.JumpPower
    char:WaitForChild("Humanoid").UseJumpPower = true
end)

if LocalPlayer.Character then
    LocalPlayer.Character:WaitForChild("Humanoid").WalkSpeed = Config.WalkSpeed
    LocalPlayer.Character:WaitForChild("Humanoid").JumpPower = Config.JumpPower
    LocalPlayer.Character:WaitForChild("Humanoid").UseJumpPower = true
end

RunService.RenderStepped:Connect(function()
    UpdateESP()
    if Config.FlyEnabled then
        if not flyBv or not flyBv.Parent then
            startFly()
        end
    end
end)

-- Xử lý sự kiện người chơi
local Connections = {}
local function Connect(event, callback)
    local connection = event:Connect(callback)
    table.insert(Connections, connection)
    return connection
end

Connect(Players.PlayerAdded, function(player)
    task.wait(math.random(2, 3))
    RemoveESP(player)
end)

Connect(Players.PlayerRemoving, function(player)
    RemoveESP(player)
end)

-- Dọn dẹp khi thoát
game:BindToClose(function()
    for _, connection in pairs(Connections) do
        pcall(function() connection:Disconnect() end)
    end
    for _, esp in pairs(ESPs) do
        pcall(function()
            esp.label:Destroy()
            esp.highlight:Destroy()
        end)
    end
    pcall(function() if ScreenGui and ScreenGui.Parent then ScreenGui:Destroy() end end)
    pcall(function() if espGui and espGui.Parent then espGui:Destroy() end end)
    if noclipConnection then
        noclipConnection:Disconnect()
    end
    Lighting.Brightness = oldLighting.Brightness
    Lighting.GlobalShadows = oldLighting.GlobalShadows
    Lighting.FogEnd = oldLighting.FogEnd
    Lighting.Ambient = oldLighting.Ambient
    Lighting.OutdoorAmbient = oldLighting.OutdoorAmbient
    Lighting.ClockTime = oldLighting.ClockTime
end)
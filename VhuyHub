-- XÓA GUI & NGẮT KẾT NỐI CŨ TRƯỚC KHI CHẠY LẠI
pcall(function()
    -- Xóa ScreenGui chính và GUI phụ
    local pg = game.Players.LocalPlayer:FindFirstChild("PlayerGui")
    if pg then
        for _, gui in ipairs(pg:GetChildren()) do
            if gui.Name == "DhuyxMenu" or gui.Name == "VhuyIntroGui" or gui.Name == "CButtonGui" or gui.Name == "SafeESP" or gui.Name == "CustomButtonGui" then
                gui:Destroy()
            end
        end
    end

    -- Xóa tool click TP nếu có
    local bp = game.Players.LocalPlayer:FindFirstChild("Backpack")
    if bp then
        local tool = bp:FindFirstChild("ClickTP")
        if tool then tool:Destroy() end
    end

    -- Tắt noclip nếu đang bật
    if getgenv().noclipConnection and typeof(getgenv().noclipConnection) == "RBXScriptConnection" then
        getgenv().noclipConnection:Disconnect()
        getgenv().noclipConnection = nil
    end

    -- Tắt fling
    getgenv().hiddenFling = false

    -- Xóa ESP nếu còn tồn tại
    if getgenv().ESPs then
        for _, esp in pairs(getgenv().ESPs) do
            pcall(function()
                if esp.label then esp.label:Destroy() end
                if esp.highlight then esp.highlight:Destroy() end
            end)
        end
        getgenv().ESPs = {}
    end

    -- Ngắt tất cả kết nối đã lưu
    if getgenv().Connections then
        for _, conn in pairs(getgenv().Connections) do
            pcall(function() conn:Disconnect() end)
        end
        getgenv().Connections = {}
    end
end)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local HttpService = game:GetService("HttpService")

-- Tạo file config riêng cho mỗi người chơi
local ConfigFile = "mygui_config_" .. LocalPlayer.UserId .. ".json"

-- Cấu trúc config mặc định
local Config = {
    Buttons = {}, -- Lưu keybind + trạng thái của từng chức năng
    GuiPosition = {X = 0, Y = 0}, -- Vị trí GUI
    GuiVisible = true, -- Trạng thái hiện/ẩn menu
    ESPEnabled = false,
    SpeedEnabled = false,
    FlyEnabled = false,
    AimbotEnabled = false,
    FullbrightEnabled = false,
    NoclipEnabled = false,
    ShiftAmount = 0.5,
    SelectedPlayers = {},
    FlySpeed = 35,
    SpeedAmount = 20,
    infiniteJumpEnabled = false,
    clickTpEnabled = false,
    checkKOAimbot = false,
    CustomPing = nil,
    FOV = 70,
    AntiLockEnabled = false,
    AutoReloadEnabled = false,
    NoStompAnimEnabled = false, -- Sẽ đổi thành InstantStompEnabled
    AntiAFKEnabled = false,
    SelectedGun = nil,
    SelectedAmmo = nil,
    AutoKillEnabled = false,
    AutoStompEnabled = false,
    AntiStompEnabled = false
}

-- Hàm lưu config
local function SaveSettings()
    local success, err = pcall(function()
        writefile(ConfigFile, HttpService:JSONEncode(Config))
    end)
    if not success then
        warn("[SaveSettings] Lỗi lưu config:", err)
    end
end

-- Hàm load config
local function LoadSettings()
    if isfile(ConfigFile) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(ConfigFile))
        end)
        if success and type(data) == "table" then
            for k, v in pairs(data) do
                Config[k] = v
            end
        else
            warn("[LoadSettings] Lỗi đọc config:", data)
        end
    else
        SaveSettings()
    end
end

LoadSettings()

local autoSelect = false
local tbEnabled = false
local fovRadius = 20
local Player = nil
local camera = Workspace.CurrentCamera
local camConnection
local clickTpTool = nil
local savedWaypoint = nil
local noclipConnection = nil
local autoKillEnabled = false
local autoKillLoop = nil
local keybindConnections = {}
local customButtons = {} -- Lưu các screenBtn để destroy khi cần
local antiStompSavedPos = nil
local antiStompLoop = nil
local autoStompLoop = nil

-- Biến lưu trạng thái Lighting cũ cho Fullbright
local oldLighting = {
    Brightness = Lighting.Brightness,
    GlobalShadows = Lighting.GlobalShadows,
    FogEnd = Lighting.FogEnd,
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    ClockTime = Lighting.ClockTime
}

-- Danh sách animation
local animations = {
    C = "http://www.roblox.com/asset/?id=15609995579",
    N = "http://www.roblox.com/asset/?id=14352343065",
}

local currentTrack = nil
local currentKey = nil
local renderConnection = nil
local inputConnection = nil

-- Hàm gửi thông báo
local function sendNotification(title, text)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = 3
    })
end

-- Hàm thiết lập nhân vật
local function setupCharacter(char)
    local hum = char:WaitForChild("Humanoid", 5)
    if not hum then return end

    local animator = hum:FindFirstChildOfClass("Animator") or Instance.new("Animator", hum)

    if renderConnection then renderConnection:Disconnect() end
    if inputConnection then inputConnection:Disconnect() end

    renderConnection = RunService.RenderStepped:Connect(function()
        if currentTrack and hum.MoveDirection.Magnitude > 0 then
            currentTrack:Stop()
            currentTrack = nil
            currentKey = nil
        end
    end)

    inputConnection = UserInputService.InputBegan:Connect(function(input)
        local key = input.KeyCode.Name
        local animId = animations[key]
        if animId and hum.MoveDirection.Magnitude == 0 then
            if currentTrack then
                currentTrack:Stop()
                currentTrack = nil
                currentKey = nil
            end
            local anim = Instance.new("Animation")
            anim.AnimationId = animId
            local track = animator:LoadAnimation(anim)
            track:Play()
            currentTrack = track
            currentKey = key
        end
    end)
end

if LocalPlayer.Character then
    setupCharacter(LocalPlayer.Character)
end

LocalPlayer.CharacterAdded:Connect(function(char)
    currentTrack = nil
    currentKey = nil
    task.wait(0.2)
    setupCharacter(char)
end)

-- Tạo hiệu ứng mờ nền
local blur = Instance.new("BlurEffect")
blur.Size = 20
blur.Parent = Lighting

-- Tạo GUI intro
local introGui = Instance.new("ScreenGui")
introGui.Name = "VhuyIntroGui"
introGui.IgnoreGuiInset = true
introGui.ResetOnSpawn = false
introGui.DisplayOrder = 99999
introGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local bg = Instance.new("Frame")
bg.Size = UDim2.new(1, 0, 1, 0)
bg.BackgroundColor3 = Color3.new(0, 0, 0)
bg.BackgroundTransparency = 1
bg.Parent = introGui

local title = Instance.new("TextLabel")
title.AnchorPoint = Vector2.new(0.5, 0.5)
title.Position = UDim2.new(0.5, 0, 0.5, 0)
title.Size = UDim2.new(0, 400, 0, 120)
title.Text = "DhuyxDtuyen"
title.Font = Enum.Font.GothamBlack
title.TextColor3 = Color3.fromRGB(255, 179, 186)
title.TextScaled = true
title.TextTransparency = 1
title.BackgroundTransparency = 1
title.Parent = introGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = title

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 179, 186)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 100, 100))
}
gradient.Rotation = 45
gradient.Parent = title

TweenService:Create(title, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.In), {TextTransparency = 0}):Play()
TweenService:Create(bg, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.In), {BackgroundTransparency = 0.4}):Play()

task.delay(4, function()
    TweenService:Create(title, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {TextTransparency = 1}):Play()
    TweenService:Create(bg, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {BackgroundTransparency = 1}):Play()
    task.delay(1.5, function()
        introGui:Destroy()
        blur:Destroy()
    end)
end)

-- Tạo GUI nút C
local cButtonGui = Instance.new("ScreenGui")
cButtonGui.Name = "CButtonGui"
cButtonGui.ResetOnSpawn = false
cButtonGui.IgnoreGuiInset = true
cButtonGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local cButton = Instance.new("TextButton")
cButton.Name = "PlayCButton"
cButton.Size = UDim2.new(0, 50, 0, 50)
cButton.Position = UDim2.new(0, 20, 0, 300)
cButton.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
cButton.Text = "C"
cButton.TextColor3 = Color3.new(0, 0, 0)
cButton.TextScaled = true
cButton.AutoButtonColor = true
cButton.Parent = cButtonGui

local cCorner = Instance.new("UICorner")
cCorner.CornerRadius = UDim.new(0.5, 0)
cCorner.Parent = cButton

local cGradient = Instance.new("UIGradient")
cGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 179, 186)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 100, 100))
}
cGradient.Rotation = 90
cGradient.Parent = cButton

local function animateCButton()
    cButton.MouseEnter:Connect(function()
        TweenService:Create(cButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 200, 200)}):Play()
    end)
    cButton.MouseLeave:Connect(function()
        TweenService:Create(cButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 179, 186)}):Play()
    end)
end
animateCButton()

local dragging = false
local dragStart, startPos

local function updateCButton(input)
    local delta = input.Position - dragStart
    cButton.Position = UDim2.new(
        startPos.X.Scale, startPos.X.Offset + delta.X,
        startPos.Y.Scale, startPos.Y.Offset + delta.Y
    )
end

cButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = cButton.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        updateCButton(input)
    end
end)

cButton.MouseButton1Click:Connect(function()
    local char = LocalPlayer.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum or hum.MoveDirection.Magnitude > 0 then return end

    local animator = hum:FindFirstChildOfClass("Animator") or Instance.new("Animator", hum)
    local anim = Instance.new("Animation")
    anim.AnimationId = animations["C"]
    local track = animator:LoadAnimation(anim)

    if currentTrack then
        currentTrack:Stop()
    end

    track:Play()
    currentTrack = track
    currentKey = "C"
    sendNotification("Animation", "Playing C animation!")
end)

-- Hàm dịch chuyển đến người gần nhất
local function TeleportToClosest()
    local closestKO, closestAlive = nil, nil
    local minDistKO, minDistAlive = math.huge, math.huge
    local myPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position

    if not myPos then return end

    for name, selected in pairs(Config.SelectedPlayers) do
        if selected then
            local plr = Players:FindFirstChild(name)
            if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local pos = plr.Character.HumanoidRootPart.Position
                local dist = (myPos - pos).Magnitude
                local bodyEffects = plr.Character:FindFirstChild("BodyEffects")
                local koValue = bodyEffects and bodyEffects:FindFirstChild("K.O")
                if koValue and koValue.Value then
                    if dist < minDistKO then
                        closestKO = plr
                        minDistKO = dist
                    end
                else
                    if dist < minDistAlive then
                        closestAlive = plr
                        minDistAlive = dist
                    end
                end
            end
        end
    end

    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    local oldPos = root.CFrame

    if closestKO then
        local torso = closestKO.Character:FindFirstChild("Torso") or closestKO.Character:FindFirstChild("HumanoidRootPart")
        if torso then
            root.CFrame = torso.CFrame
            task.wait(0.2)
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            task.wait(0.1)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
            task.wait(1.5)
            root.CFrame = oldPos
        end
    elseif closestAlive then
        local torso = closestAlive.Character:FindFirstChild("HumanoidRootPart") or closestAlive.Character:FindFirstChild("HumanoidRootPart")
        if torso then
            root.CFrame = torso.CFrame + Vector3.new(0, 30, 0)
        end
    end
end

-- GUI chính
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DhuyxMenu"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = PlayerGui

local MenuFrame = Instance.new("Frame")
MenuFrame.Size = UDim2.new(0, 300, 0, 250)
MenuFrame.Position = UDim2.new(0.05, 0, 0.2, 0)
MenuFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MenuFrame.BackgroundTransparency = 0.1
MenuFrame.Active = true
MenuFrame.Draggable = true
MenuFrame.Parent = ScreenGui
Instance.new("UICorner", MenuFrame).CornerRadius = UDim.new(0, 12)

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 179, 186)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(100, 100, 255))
}
gradient.Rotation = 45
gradient.Parent = MenuFrame

local stroke = Instance.new("UIStroke")
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(255, 255, 255)
stroke.Transparency = 0.3
stroke.Parent = MenuFrame

-- Nút Toggle Show/Hide
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 70, 0, 30)
ToggleButton.Position = UDim2.new(0, 20, 0, 240)
ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
ToggleButton.Text = Config.GuiVisible and "HIDE" or "SHOW"
ToggleButton.TextColor3 = Color3.new(0, 0, 0)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 16
ToggleButton.Active = true
ToggleButton.Draggable = true
ToggleButton.Parent = ScreenGui
Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 10)

local toggleGradient = Instance.new("UIGradient")
toggleGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 179, 186)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 100, 100))
}
toggleGradient.Parent = ToggleButton

local function animateButton(btn)
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 200, 200)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 179, 186)}):Play()
    end)
    btn.MouseButton1Click:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.1), {Size = btn.Size + UDim2.new(0, 5, 0, 5)}):Play()
        task.wait(0.1)
        TweenService:Create(btn, TweenInfo.new(0.1), {Size = btn.Size - UDim2.new(0, 5, 0, 5)}):Play()
    end)
end
animateButton(ToggleButton)

ToggleButton.MouseButton1Click:Connect(function()
    Config.GuiVisible = not Config.GuiVisible
    local targetSize = Config.GuiVisible and UDim2.new(0, 300, 0, 250) or UDim2.new(0, 0, 0, 0)
    local tween = TweenService:Create(MenuFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = targetSize})
    if Config.GuiVisible then
        MenuFrame.Visible = true
        tween:Play()
    else
        tween:Play()
        tween.Completed:Wait()
        MenuFrame.Visible = false
    end
    ToggleButton.Text = Config.GuiVisible and "HIDE" or "SHOW"
    SaveSettings()
end)

-- Tiêu đề & Ping/FPS/Clock
local MenuTitle = Instance.new("TextLabel")
MenuTitle.Size = UDim2.new(1, 0, 0, 30)
MenuTitle.BackgroundTransparency = 1
MenuTitle.Text = "DhuyxDtuyen"
MenuTitle.TextColor3 = Color3.fromRGB(255, 179, 186)
MenuTitle.Font = Enum.Font.GothamBlack
MenuTitle.TextSize = 18
MenuTitle.Parent = MenuFrame

local PingClock = Instance.new("TextLabel")
PingClock.Size = UDim2.new(0, 200, 0, 25)
PingClock.Position = UDim2.new(0, 5, 0, -30)
PingClock.BackgroundTransparency = 1
PingClock.TextColor3 = Color3.fromRGB(255, 255, 255)
PingClock.Font = Enum.Font.Gotham
PingClock.TextSize = 14
PingClock.Parent = MenuTitle

task.spawn(function()
    while task.wait(1) do
        local ping = math.floor(game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue())
        local fps = math.floor(1 / RunService.RenderStepped:Wait())
        local timeStr = os.date("%H:%M")
        PingClock.Text = string.format("Ping: %d ms | FPS: %d | %s", ping, fps, timeStr)
    end
end)

local PingBox = Instance.new("TextBox")
PingBox.Size = UDim2.new(0, 80, 0, 25)
PingBox.Position = UDim2.new(1, -85, 0, 2)
PingBox.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
PingBox.BackgroundTransparency = 0.2
PingBox.TextColor3 = Color3.fromRGB(0, 0, 0)
PingBox.TextSize = 14
PingBox.Font = Enum.Font.Gotham
PingBox.PlaceholderText = "Ping (ms)"
PingBox.Text = Config.CustomPing and tostring(Config.CustomPing) or ""
PingBox.ClearTextOnFocus = false
PingBox.Parent = MenuTitle
Instance.new("UICorner", PingBox).CornerRadius = UDim.new(0, 6)

PingBox:GetPropertyChangedSignal("Text"):Connect(function()
    local input = tonumber(PingBox.Text)
    if input and input >= 0 then
        Config.CustomPing = math.clamp(input, 10, 1000)
    else
        Config.CustomPing = nil
    end
    SaveSettings()
end)

-- Tạo 3 trang
local currentPage = 1

local Page1 = Instance.new("Frame")
Page1.Size = UDim2.new(1, 0, 1, -70)
Page1.Position = UDim2.new(0, 0, 0, 30)
Page1.BackgroundTransparency = 1
Page1.Parent = MenuFrame

local PlayerListFrame = Instance.new("Frame")
PlayerListFrame.Size = UDim2.new(0.5, -5, 1, -20)
PlayerListFrame.Position = UDim2.new(0, 5, 0, 10)
PlayerListFrame.BackgroundTransparency = 1
PlayerListFrame.Parent = Page1

local PlayerList = Instance.new("ScrollingFrame")
PlayerList.Size = UDim2.new(1, 0, 1, 0)
PlayerList.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayerList.ScrollBarThickness = 4
PlayerList.BackgroundTransparency = 1
PlayerList.Parent = PlayerListFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 4)
UIListLayout.Parent = PlayerList
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    PlayerList.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y)
end)

local ButtonFrame1 = Instance.new("ScrollingFrame")
ButtonFrame1.Size = UDim2.new(0.5, -5, 1, -20)
ButtonFrame1.Position = UDim2.new(0.5, 0, 0, 10)
ButtonFrame1.BackgroundTransparency = 1
ButtonFrame1.ScrollBarThickness = 4
ButtonFrame1.CanvasSize = UDim2.new(0, 0, 0, 0)
ButtonFrame1.Parent = Page1

local ButtonLayout1 = Instance.new("UIListLayout")
ButtonLayout1.SortOrder = Enum.SortOrder.LayoutOrder
ButtonLayout1.Padding = UDim.new(0, 6)
ButtonLayout1.Parent = ButtonFrame1
ButtonLayout1:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ButtonFrame1.CanvasSize = UDim2.new(0, 0, 0, ButtonLayout1.AbsoluteContentSize.Y)
end)

local Page2 = Instance.new("Frame")
Page2.Size = UDim2.new(1, 0, 1, -70)
Page2.Position = UDim2.new(0, 0, 0, 30)
Page2.BackgroundTransparency = 1
Page2.Visible = false
Page2.Parent = MenuFrame

local ButtonFrame2Left = Instance.new("ScrollingFrame")
ButtonFrame2Left.Size = UDim2.new(0.5, -5, 1, -20)
ButtonFrame2Left.Position = UDim2.new(0, 5, 0, 10)
ButtonFrame2Left.BackgroundTransparency = 1
ButtonFrame2Left.ScrollBarThickness = 4
ButtonFrame2Left.CanvasSize = UDim2.new(0, 0, 0, 0)
ButtonFrame2Left.Parent = Page2

local ButtonLayout2Left = Instance.new("UIListLayout")
ButtonLayout2Left.SortOrder = Enum.SortOrder.LayoutOrder
ButtonLayout2Left.Padding = UDim.new(0, 6)
ButtonLayout2Left.Parent = ButtonFrame2Left
ButtonLayout2Left:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ButtonFrame2Left.CanvasSize = UDim2.new(0, 0, 0, ButtonLayout2Left.AbsoluteContentSize.Y)
end)

local ButtonFrame2Right = Instance.new("ScrollingFrame")
ButtonFrame2Right.Size = UDim2.new(0.5, -5, 1, -20)
ButtonFrame2Right.Position = UDim2.new(0.5, 0, 0, 10)
ButtonFrame2Right.BackgroundTransparency = 1
ButtonFrame2Right.ScrollBarThickness = 4
ButtonFrame2Right.CanvasSize = UDim2.new(0, 0, 0, 0)
ButtonFrame2Right.Parent = Page2

local ButtonLayout2Right = Instance.new("UIListLayout")
ButtonLayout2Right.SortOrder = Enum.SortOrder.LayoutOrder
ButtonLayout2Right.Padding = UDim.new(0, 6)
ButtonLayout2Right.Parent = ButtonFrame2Right
ButtonLayout2Right:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ButtonFrame2Right.CanvasSize = UDim2.new(0, 0, 0, ButtonLayout2Right.AbsoluteContentSize.Y)
end)

local Page3 = Instance.new("Frame")
Page3.Size = UDim2.new(1, 0, 1, -70)
Page3.Position = UDim2.new(0, 0, 0, 30)
Page3.BackgroundTransparency = 1
Page3.Visible = false
Page3.Parent = MenuFrame

local ScriptHubScroll = Instance.new("ScrollingFrame")
ScriptHubScroll.Size = UDim2.new(1, -10, 1, -50)
ScriptHubScroll.Position = UDim2.new(0, 5, 0, 5)
ScriptHubScroll.BackgroundTransparency = 1
ScriptHubScroll.ScrollBarThickness = 6
ScriptHubScroll.ScrollingDirection = Enum.ScrollingDirection.Y
ScriptHubScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
ScriptHubScroll.Parent = Page3

local ScriptListLayout = Instance.new("UIListLayout")
ScriptListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ScriptListLayout.Padding = UDim.new(0, 6)
ScriptListLayout.FillDirection = Enum.FillDirection.Vertical
ScriptListLayout.Parent = ScriptHubScroll

ScriptListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScriptHubScroll.CanvasSize = UDim2.new(0, 0, 0, ScriptListLayout.AbsoluteContentSize.Y)
end)

local function CreateScriptItem(name, url)
    local itemFrame = Instance.new("Frame")
    itemFrame.Size = UDim2.new(1, 0, 0, 35)
    itemFrame.BackgroundTransparency = 0.2
    itemFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    itemFrame.Parent = ScriptHubScroll
    Instance.new("UICorner", itemFrame).CornerRadius = UDim.new(0, 6)

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(0.7, 0, 1, 0)
    nameLabel.Position = UDim2.new(0, 5, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = name
    nameLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextSize = 16
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = itemFrame

    local runBtn = Instance.new("TextButton")
    runBtn.Size = UDim2.new(0.3, -10, 1, -4)
    runBtn.Position = UDim2.new(0.7, 5, 0, 2)
    runBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
    runBtn.Text = "Run"
    runBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
    runBtn.TextSize = 16
    runBtn.Font = Enum.Font.GothamBold
    runBtn.Parent = itemFrame
    Instance.new("UICorner", runBtn).CornerRadius = UDim.new(0, 6)
    animateButton(runBtn)

    runBtn.MouseButton1Click:Connect(function()
        loadstring(game:HttpGet(url))()
    end)

    return itemFrame
end

CreateScriptItem("Evade", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/evade")
CreateScriptItem("Murder Mystery 2", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/mm2")
CreateScriptItem("Blade Ball", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/Bladeball")
CreateScriptItem("Doors", "https://raw.githubusercontent.com/DarkDoorsKing/Project/main/Doors.lua")
CreateScriptItem("Emote", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/emote")

local PageButtons = Instance.new("Frame")
PageButtons.Size = UDim2.new(1, 0, 0, 35)
PageButtons.Position = UDim2.new(0, 0, 1, -35)
PageButtons.BackgroundTransparency = 1
PageButtons.Parent = MenuFrame

local Btn1 = Instance.new("TextButton")
Btn1.Size = UDim2.new(1/3, -2, 1, 0)
Btn1.Position = UDim2.new(0, 0, 0, 0)
Btn1.Text = "Da Hood"
Btn1.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
Btn1.TextColor3 = Color3.fromRGB(0, 0, 0)
Btn1.Font = Enum.Font.GothamBold
Btn1.TextSize = 16
Instance.new("UICorner", Btn1).CornerRadius = UDim.new(0, 6)
Btn1.Parent = PageButtons
animateButton(Btn1)

local Btn2 = Instance.new("TextButton")
Btn2.Size = UDim2.new(1/3, -2, 1, 0)
Btn2.Position = UDim2.new(1/3, 2, 0, 0)
Btn2.Text = "Universal"
Btn2.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
Btn2.TextColor3 = Color3.fromRGB(0, 0, 0)
Btn2.Font = Enum.Font.GothamBold
Btn2.TextSize = 16
Instance.new("UICorner", Btn2).CornerRadius = UDim.new(0, 6)
Btn2.Parent = PageButtons
animateButton(Btn2)

local Btn3 = Instance.new("TextButton")
Btn3.Size = UDim2.new(1/3, -2, 1, 0)
Btn3.Position = UDim2.new(2/3, 2, 0, 0)
Btn3.Text = "Script Other"
Btn3.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
Btn3.TextColor3 = Color3.fromRGB(0, 0, 0)
Btn3.Font = Enum.Font.GothamBold
Btn3.TextSize = 16
Instance.new("UICorner", Btn3).CornerRadius = UDim.new(0, 6)
Btn3.Parent = PageButtons
animateButton(Btn3)

local function ShowPage(page)
    Page1.Visible = (page == 1)
    Page2.Visible = (page == 2)
    Page3.Visible = (page == 3)
end

Btn1.MouseButton1Click:Connect(function()
    ShowPage(1)
end)
Btn2.MouseButton1Click:Connect(function()
    ShowPage(2)
end)
Btn3.MouseButton1Click:Connect(function()
    ShowPage(3)
end)

-- Tạo GUI cho nút tùy chỉnh ngoài menu
local CustomButtonGui = Instance.new("ScreenGui")
CustomButtonGui.Name = "CustomButtonGui"
CustomButtonGui.ResetOnSpawn = false
CustomButtonGui.IgnoreGuiInset = true
CustomButtonGui.Parent = game:GetService("CoreGui")

local function CreateButton(parent, name, callback, configKey)
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Size = UDim2.new(1, -10, 0, 30)
    buttonFrame.BackgroundTransparency = 1
    buttonFrame.Parent = parent

    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0.7, -5, 1, 0)
    button.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
    button.BackgroundTransparency = 0.2
    button.TextColor3 = Color3.fromRGB(0, 0, 0)
    button.TextSize = 14
    button.Font = Enum.Font.Gotham
    button.Parent = buttonFrame
    Instance.new("UICorner", button).CornerRadius = UDim.new(0, 6)
    animateButton(button)

    local keyBox = Instance.new("TextBox")
    keyBox.Size = UDim2.new(0.3, 0, 1, 0)
    keyBox.Position = UDim2.new(0.7, 5, 0, 0)
    keyBox.BackgroundColor3 = Color3.fromRGB(230, 230, 230)
    keyBox.PlaceholderText = "Key"
    keyBox.Text = Config.Buttons[name] or ""
    keyBox.TextColor3 = Color3.fromRGB(0, 0, 0)
    keyBox.TextSize = 14
    keyBox.Font = Enum.Font.Gotham
    keyBox.ClearTextOnFocus = false
    keyBox.Parent = buttonFrame
    Instance.new("UICorner", keyBox).CornerRadius = UDim.new(0, 6)

    if configKey then
        -- Nút toggle ON/OFF
        button.Text = name .. ": " .. (Config[configKey] and "ON" or "OFF")
        button.MouseButton1Click:Connect(function()
            Config[configKey] = not Config[configKey]
            button.Text = name .. ": " .. (Config[configKey] and "ON" or "OFF")
            if customButtons[name] then
                customButtons[name].Text = name .. ": " .. (Config[configKey] and "ON" or "OFF")
            end
            callback()
            SaveSettings()
        end)
    else
        -- Nút hành động một lần, không ON/OFF
        button.Text = name
        button.MouseButton1Click:Connect(function()
            callback()
        end)
    end

    keyBox:GetPropertyChangedSignal("Text"):Connect(function()
        local text = keyBox.Text:lower()
        Config.Buttons[name] = text
        SaveSettings()

        -- Xóa keybind cũ
        if keybindConnections[name] then
            keybindConnections[name]:Disconnect()
            keybindConnections[name] = nil
        end

        -- Xử lý screenBtn
        if customButtons[name] then
            customButtons[name]:Destroy()
            customButtons[name] = nil
        end

        if text == "button" then
            local screenBtn = Instance.new("TextButton")
            screenBtn.Size = UDim2.new(0, 70, 0, 30)
            screenBtn.Position = UDim2.new(0, 100, 0, 300)
            screenBtn.BackgroundColor3 = Color3.fromRGB(200, 200, 255)
            screenBtn.Text = configKey and (name .. ": " .. (Config[configKey] and "ON" or "OFF")) or name
            screenBtn.TextColor3 = Color3.new(0, 0, 0)
            screenBtn.TextSize = 10
            screenBtn.Font = Enum.Font.GothamBold
            screenBtn.Parent = CustomButtonGui
            Instance.new("UICorner", screenBtn).CornerRadius = UDim.new(0, 6)

            local dragging = false
            local dragStart, startPos
            screenBtn.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    dragStart = input.Position
                    startPos = screenBtn.Position
                    input.Changed:Connect(function()
                        if input.UserInputState == Enum.UserInputState.End then
                            dragging = false
                        end
                    end)
                end
            end)
            UserInputService.InputChanged:Connect(function(input)
                if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    local delta = input.Position - dragStart
                    screenBtn.Position = UDim2.new(
                        startPos.X.Scale, startPos.X.Offset + delta.X,
                        startPos.Y.Scale, startPos.Y.Offset + delta.Y
                    )
                end
            end)

            screenBtn.MouseButton1Click:Connect(function()
                if configKey then
                    Config[configKey] = not Config[configKey]
                    screenBtn.Text = name .. ": " .. (Config[configKey] and "ON" or "OFF")
                    button.Text = name .. ": " .. (Config[configKey] and "ON" or "OFF")
                    callback()
                    SaveSettings()
                else
                    callback()
                end
            end)

            customButtons[name] = screenBtn
        else
            local keyName = text:upper()
            if Enum.KeyCode[keyName] then
                keybindConnections[name] = UserInputService.InputBegan:Connect(function(input, gp)
                    if not gp and input.KeyCode.Name:upper() == keyName then
                        if configKey then
                            Config[configKey] = not Config[configKey]
                            button.Text = name .. ": " .. (Config[configKey] and "ON" or "OFF")
                            if customButtons[name] then
                                customButtons[name].Text = name .. ": " .. (Config[configKey] and "ON" or "OFF")
                            end
                            callback()
                            SaveSettings()
                        else
                            callback()
                        end
                    end
                end)
            end
        end
    end)

    if Config.Buttons[name] then
        keyBox.Text = Config.Buttons[name]
        keyBox:CaptureFocus()
        keyBox:ReleaseFocus()
    end

    return button
end

-- Danh sách súng và ammo trong Da Hood (tọa độ cập nhật từ cộng đồng)
local Guns = {
    ["Revolver"] = CFrame.new(-635.258, 22.349, -723.054),
    ["Pistol"] = CFrame.new(-581.563, 22.349, -588.322),
    ["Shotgun"] = CFrame.new(-581.563, 22.349, -588.322),
    ["SMG"] = CFrame.new(-581.563, 22.349, -588.322),
    ["RPG"] = CFrame.new(-1039.789, 22.349, -596.123)
}

local Ammo = {
    ["Revolver Ammo"] = CFrame.new(-581.563, 22.349, -588.322),
    ["Pistol Ammo"] = CFrame.new(-581.563, 22.349, -588.322),
    ["Shotgun Ammo"] = CFrame.new(-581.563, 22.349, -588.322),
    ["SMG Ammo"] = CFrame.new(-581.563, 22.349, -588.322),
    ["RPG Ammo"] = CFrame.new(-1039.789, 22.349, -596.123)
}

-- Tạo dropdown cho súng
local function CreateGunDropdown(parent)
    local dropdownFrame = Instance.new("Frame")
    dropdownFrame.Size = UDim2.new(1, -10, 0, 30)
    dropdownFrame.BackgroundTransparency = 1
    dropdownFrame.Parent = parent

    local selectButton = Instance.new("TextButton")
    selectButton.Size = UDim2.new(1, 0, 1, 0)
    selectButton.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
    selectButton.Text = Config.SelectedGun or "Select Gun"
    selectButton.TextColor3 = Color3.fromRGB(0, 0, 0)
    selectButton.TextSize = 14
    selectButton.Font = Enum.Font.Gotham
    selectButton.Parent = dropdownFrame
    Instance.new("UICorner", selectButton).CornerRadius = UDim.new(0, 6)
    animateButton(selectButton)

    local dropdownList = Instance.new("ScrollingFrame")
    dropdownList.Size = UDim2.new(1, 0, 0, 100)
    dropdownList.Position = UDim2.new(0, 0, 1, 5)
    dropdownList.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    dropdownList.BackgroundTransparency = 0.2
    dropdownList.ScrollBarThickness = 4
    dropdownList.Visible = false
    dropdownList.ZIndex = 15 -- Tăng ZIndex để tránh bị che
    dropdownList.Parent = dropdownFrame
    Instance.new("UICorner", dropdownList).CornerRadius = UDim.new(0, 6)

    local listLayout = Instance.new("UIListLayout")
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0, 4)
    listLayout.Parent = dropdownList
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        dropdownList.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
    end)

    selectButton.MouseButton1Click:Connect(function()
        dropdownList.Visible = not dropdownList.Visible
        -- Di chuyển các nút khác xuống dưới khi dropdown mở
        local offset = dropdownList.Visible and 110 or 0
        for _, child in ipairs(ButtonFrame1:GetChildren()) do
            if child:IsA("Frame") and child ~= dropdownFrame then
                child.Position = child.Position + UDim2.new(0, 0, 0, offset)
            end
        end
    end)

    for gun, _ in pairs(Guns) do
        local gunButton = Instance.new("TextButton")
        gunButton.Size = UDim2.new(1, -4, 0, 20)
        gunButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        gunButton.BackgroundTransparency = 0.2
        gunButton.Text = gun
        gunButton.TextColor3 = Color3.fromRGB(0, 0, 0)
        gunButton.TextSize = 14
        gunButton.Font = Enum.Font.Gotham
        gunButton.ZIndex = 15 -- Tăng ZIndex
        gunButton.Parent = dropdownList
        animateButton(gunButton)

        gunButton.MouseButton1Click:Connect(function()
            Config.SelectedGun = gun
            selectButton.Text = gun
            dropdownList.Visible = false
            -- Khôi phục vị trí các nút
            for _, child in ipairs(ButtonFrame1:GetChildren()) do
                if child:IsA("Frame") and child ~= dropdownFrame then
                    child.Position = child.Position - UDim2.new(0, 0, 0, 110)
                end
            end
            SaveSettings()
        end)
    end
end

-- Tạo dropdown cho ammo
local function CreateAmmoDropdown(parent)
    local dropdownFrame = Instance.new("Frame")
    dropdownFrame.Size = UDim2.new(1, -10, 0, 30)
    dropdownFrame.BackgroundTransparency = 1
    dropdownFrame.Parent = parent

    local selectButton = Instance.new("TextButton")
    selectButton.Size = UDim2.new(1, 0, 1, 0)
    selectButton.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
    selectButton.Text = Config.SelectedAmmo or "Select Ammo"
    selectButton.TextColor3 = Color3.fromRGB(0, 0, 0)
    selectButton.TextSize = 14
    selectButton.Font = Enum.Font.Gotham
    selectButton.Parent = dropdownFrame
    Instance.new("UICorner", selectButton).CornerRadius = UDim.new(0, 6)
    animateButton(selectButton)

    local dropdownList = Instance.new("ScrollingFrame")
    dropdownList.Size = UDim2.new(1, 0, 0, 100)
    dropdownList.Position = UDim2.new(0, 0, 1, 5)
    dropdownList.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    dropdownList.BackgroundTransparency = 0.2
    dropdownList.ScrollBarThickness = 4
    dropdownList.Visible = false
    dropdownList.ZIndex = 15 -- Tăng ZIndex
    dropdownList.Parent = dropdownFrame
    Instance.new("UICorner", dropdownList).CornerRadius = UDim.new(0, 6)

    local listLayout = Instance.new("UIListLayout")
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0, 4)
    listLayout.Parent = dropdownList
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        dropdownList.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
    end)

    selectButton.MouseButton1Click:Connect(function()
        dropdownList.Visible = not dropdownList.Visible
        -- Di chuyển các nút khác xuống dưới khi dropdown mở
        local offset = dropdownList.Visible and 110 or 0
        for _, child in ipairs(ButtonFrame1:GetChildren()) do
            if child:IsA("Frame") and child ~= dropdownFrame then
                child.Position = child.Position + UDim2.new(0, 0, 0, offset)
            end
        end
    end)

    for ammo, _ in pairs(Ammo) do
        local ammoButton = Instance.new("TextButton")
        ammoButton.Size = UDim2.new(1, -4, 0, 20)
        ammoButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        ammoButton.BackgroundTransparency = 0.2
        ammoButton.Text = ammo
        ammoButton.TextColor3 = Color3.fromRGB(0, 0, 0)
        ammoButton.TextSize = 14
        ammoButton.Font = Enum.Font.Gotham
        ammoButton.ZIndex = 15 -- Tăng ZIndex
        ammoButton.Parent = dropdownList
        animateButton(ammoButton)

        ammoButton.MouseButton1Click:Connect(function()
            Config.SelectedAmmo = ammo
            selectButton.Text = ammo
            dropdownList.Visible = false
            -- Khôi phục vị trí các nút
            for _, child in ipairs(ButtonFrame1:GetChildren()) do
                if child:IsA("Frame") and child ~= dropdownFrame then
                    child.Position = child.Position - UDim2.new(0, 0, 0, 110)
                end
            end
            SaveSettings()
        end)
    end
end

-- Nút cho trang 1 (Da Hood)
espButton = CreateButton(ButtonFrame1, "ESP", function()
    sendNotification("ESP", Config.ESPEnabled and "ON" or "OFF")
end, "ESPEnabled")

speedButton = CreateButton(ButtonFrame1, "Speed", function()
    sendNotification("SPEED", Config.SpeedEnabled and "ON" or "OFF")
end, "SpeedEnabled")

flyButton = CreateButton(ButtonFrame1, "Fly", function()
    sendNotification("FLY", Config.FlyEnabled and "ON" or "OFF")
end, "FlyEnabled")

aimbotButton = CreateButton(ButtonFrame1, "Aimbot", function()
    sendNotification("AIMBOT", Config.AimbotEnabled and "ON" or "OFF")
end, "AimbotEnabled")

checkKOAimbotButton = CreateButton(ButtonFrame1, "Check K.O Aimbot", function()
    sendNotification("CHECK K.O AIMBOT", Config.checkKOAimbot and "ON" or "OFF")
end, "checkKOAimbot")

triggerBotButton = CreateButton(ButtonFrame1, "TriggerBot", function()
    tbEnabled = not tbEnabled
    triggerBotButton.Text = "TriggerBot: " .. (tbEnabled and "ON" or "OFF")
    sendNotification("TRIGGERBOT", tbEnabled and "ON" or "OFF")
    SaveSettings()
end, "TriggerBotEnabled")

tpAndStompButton = CreateButton(ButtonFrame1, "TP Player", TeleportToClosest, nil)

autoKillButton = CreateButton(ButtonFrame1, "AutoKill", function()
    if Config.AutoKillEnabled then
        autoKillLoop = task.spawn(function()
            while Config.AutoKillEnabled do
                local closestAlive = nil
                local minDistAlive = math.huge
                local myPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position

                if not myPos then
                    task.wait(0.1)
                    continue
                end

                for name, selected in pairs(Config.SelectedPlayers) do
                    if selected then
                        local plr = Players:FindFirstChild(name)
                        if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                            local bodyEffects = plr.Character:FindFirstChild("BodyEffects")
                            local koValue = bodyEffects and bodyEffects:FindFirstChild("K.O")
                            if not (koValue and koValue.Value) then
                                local pos = plr.Character.HumanoidRootPart.Position
                                local dist = (myPos - pos).Magnitude
                                if dist < minDistAlive then
                                    closestAlive = plr
                                    minDistAlive = dist
                                end
                            end
                        end
                    end
                end

                if closestAlive then
                    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if root then
                        local targetRoot = closestAlive.Character:FindFirstChild("HumanoidRootPart")
                        if targetRoot then
                            -- Strafe quanh mục tiêu
                            local angle = tick() % (2 * math.pi)
                            local offset = Vector3.new(math.sin(angle) * 5, 0, math.cos(angle) * 5)
                            root.CFrame = targetRoot.CFrame + offset
                            -- Aimlock và triggerbot
                            Config.AimbotEnabled = true
                            tbEnabled = true
                            local bodyEffects = closestAlive.Character:FindFirstChild("BodyEffects")
                            local koValue = bodyEffects and bodyEffects:FindFirstChild("K.O")
                            if koValue and koValue.Value then
                                Config.AimbotEnabled = false
                                tbEnabled = false
                                break
                            end
                        end
                    end
                end
                task.wait(0.05)
            end
        end)
    else
        if autoKillLoop then
            task.cancel(autoKillLoop)
            autoKillLoop = nil
        end
        Config.AimbotEnabled = false
        tbEnabled = false
    end
    sendNotification("AUTOKILL", Config.AutoKillEnabled and "ON" or "OFF")
end, "AutoKillEnabled")

antiLockButton = CreateButton(ButtonFrame1, "AntiLock", function()
    if Config.AntiLockEnabled then
        antiLockLoop = task.spawn(function()
            while Config.AntiLockEnabled do
                local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    local randomOffset = Vector3.new(math.random(-5, 5), 0, math.random(-5, 5))
                    root.CFrame = root.CFrame + randomOffset
                end
                task.wait(0.1)
            end
        end)
    else
        if antiLockLoop then
            task.cancel(antiLockLoop)
            antiLockLoop = nil
        end
    end
    sendNotification("ANTILOCK", Config.AntiLockEnabled and "ON" or "OFF")
end, "AntiLockEnabled")

autoStompButton = CreateButton(ButtonFrame1, "AutoStomp", function()
    if Config.AutoStompEnabled then
        autoStompLoop = task.spawn(function()
            while Config.AutoStompEnabled do
                local closestKO = nil
                local minDistKO = math.huge
                local myPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position

                if not myPos then
                    task.wait(0.1)
                    continue
                end

                for name, selected in pairs(Config.SelectedPlayers) do
                    if selected then
                        local plr = Players:FindFirstChild(name)
                        if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                            local bodyEffects = plr.Character:FindFirstChild("BodyEffects")
                            local koValue = bodyEffects and bodyEffects:FindFirstChild("K.O")
                            if koValue and koValue.Value then
                                local pos = plr.Character.HumanoidRootPart.Position
                                local dist = (myPos - pos).Magnitude
                                if dist < minDistKO then
                                    closestKO = plr
                                    minDistKO = dist
                                end
                            end
                        end
                    end
                end

                if closestKO then
                    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if root then
                        local oldPos = root.CFrame
                        local torso = closestKO.Character:FindFirstChild("Torso") or closestKO.Character:FindFirstChild("HumanoidRootPart")
                        if torso then
                            root.CFrame = torso.CFrame
                            task.wait(0.05)
                            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                            task.wait(0.05)
                            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                            task.wait(0.1)
                            root.CFrame = oldPos
                        end
                    end
                end
                task.wait(0.1)
            end
        end)
    else
        if autoStompLoop then
            task.cancel(autoStompLoop)
            autoStompLoop = nil
        end
    end
    sendNotification("AUTOSTOMP", Config.AutoStompEnabled and "ON" or "OFF")
end, "AutoStompEnabled")

antiStompButton = CreateButton(ButtonFrame1, "AntiStomp", function()
    if Config.AntiStompEnabled then
        antiStompLoop = task.spawn(function()
            local isDead = false
            LocalPlayer.CharacterAdded:Connect(function()
                isDead = true
                antiStompSavedPos = nil
            end)
            while Config.AntiStompEnabled do
                local char = LocalPlayer.Character
                local hum = char and char:FindFirstChildOfClass("Humanoid")
                if hum then
                    if hum.Health < 15 and not isDead then
                        antiStompSavedPos = char:FindFirstChild("HumanoidRootPart") and char.HumanoidRootPart.CFrame
                        char.HumanoidRootPart.CFrame = CFrame.new(10000, 10000, 10000)
                    elseif hum.Health >= 20 and antiStompSavedPos and not isDead then
                        char.HumanoidRootPart.CFrame = antiStompSavedPos
                        antiStompSavedPos = nil
                    end
                end
                task.wait(0.1)
            end
        end)
    else
        if antiStompLoop then
            task.cancel(antiStompLoop)
            antiStompLoop = nil
        end
        if antiStompSavedPos and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.CFrame = antiStompSavedPos
            antiStompSavedPos = nil
        end
    end
    sendNotification("ANTISTOMP", Config.AntiStompEnabled and "ON" or "OFF")
end, "AntiStompEnabled")

instantStompButton = CreateButton(ButtonFrame1, "InstantStomp", function()
    sendNotification("INSTANTSTOMP", Config.NoStompAnimEnabled and "ON" or "OFF")
end, "NoStompAnimEnabled")

instantReloadButton = CreateButton(ButtonFrame1, "InstantReload", function()
    if Config.AutoReloadEnabled then
        instantReloadLoop = task.spawn(function()
            while Config.AutoReloadEnabled do
                local char = LocalPlayer.Character
                local tool = char and char:FindFirstChildOfClass("Tool")
                if tool then
                    local ammo = tool:FindFirstChild("Ammo")
                    if ammo and ammo.Value == 0 then
                        game:GetService("ReplicatedStorage").MainEvent:FireServer("Reload", tool)
                    end
                end
                task.wait(0.05)
            end
        end)
    else
        if instantReloadLoop then
            task.cancel(instantReloadLoop)
            instantReloadLoop = nil
        end
    end
    sendNotification("INSTANTRELOAD", Config.AutoReloadEnabled and "ON" or "OFF")
end, "AutoReloadEnabled")

CreateGunDropdown(ButtonFrame1)
tpGunButton = CreateButton(ButtonFrame1, "TP Gun", function()
    if Config.SelectedGun and Guns[Config.SelectedGun] then
        local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            root.CFrame = Guns[Config.SelectedGun]
            task.wait(0.2)
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            task.wait(0.1)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
            sendNotification("TP Gun", "Teleported to " .. Config.SelectedGun .. " and purchased!")
        end
    else
        sendNotification("TP Gun", "Please select a gun first!")
    end
end, nil)

CreateAmmoDropdown(ButtonFrame1)
tpAmmoButton = CreateButton(ButtonFrame1, "TP Ammo", function()
    if Config.SelectedAmmo and Ammo[Config.SelectedAmmo] then
        local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            root.CFrame = Ammo[Config.SelectedAmmo]
            task.wait(0.2)
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            task.wait(0.1)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
            sendNotification("TP Ammo", "Teleported to " .. Config.SelectedAmmo .. " and purchased!")
        end
    else
        sendNotification("TP Ammo", "Please select ammo first!")
    end
end, nil)

-- Nút cho trang 2 (Universal)
customFovButton = CreateButton(ButtonFrame2Left, "Custom FOV", function()
    if Config.CustomFovEnabled then
        local num = tonumber(fovBox.Text) or Config.FOV
        if num and num >= 40 and num <= 120 then
            Workspace.CurrentCamera.FieldOfView = num
            Config.FOV = num
            sendNotification("Custom FOV", "Đã đặt FOV thành " .. num)
        else
            sendNotification("Custom FOV", "Hãy nhập giá trị 40-120 vào ô FOV")
        end
    else
        Workspace.CurrentCamera.FieldOfView = Config.FOV
    end
    sendNotification("CUSTOM FOV", Config.CustomFovEnabled and "ON" or "OFF")
end, "CustomFovEnabled")

fovBox = Instance.new("TextBox")
fovBox.Size = UDim2.new(1, -10, 0, 25)
fovBox.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
fovBox.BackgroundTransparency = 0.2
fovBox.TextColor3 = Color3.fromRGB(0, 0, 0)
fovBox.TextSize = 14
fovBox.Font = Enum.Font.Gotham
fovBox.PlaceholderText = "70"
fovBox.Text = tostring(Config.FOV)
fovBox.ClearTextOnFocus = false
fovBox.Parent = ButtonFrame2Left
Instance.new("UICorner", fovBox).CornerRadius = UDim.new(0, 6)

fovBox:GetPropertyChangedSignal("Text"):Connect(function()
    if Config.CustomFovEnabled then
        local num = tonumber(fovBox.Text)
        if num and num >= 40 and num <= 120 then
            Workspace.CurrentCamera.FieldOfView = num
            Config.FOV = num
            sendNotification("Custom FOV", "Đã đặt FOV thành " .. num)
            SaveSettings()
        end
    end
end)

fullbrightButton = CreateButton(ButtonFrame2Left, "Fullbright", function()
    if Config.FullbrightEnabled then
        Lighting.Brightness = 2
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 999999
        Lighting.Ambient = Color3.fromRGB(255, 255, 255)
        Lighting.OutdoorAmbient = Color3.fromRGB(255, 255, 255)
        Lighting.ClockTime = 12
    else
        Lighting.Brightness = oldLighting.Brightness
        Lighting.GlobalShadows = oldLighting.GlobalShadows
        Lighting.FogEnd = oldLighting.FogEnd
        Lighting.Ambient = oldLighting.Ambient
        Lighting.OutdoorAmbient = oldLighting.OutdoorAmbient
        Lighting.ClockTime = oldLighting.ClockTime
    end
    sendNotification("FULLBRIGHT", Config.FullbrightEnabled and "ON" or "OFF")
end, "FullbrightEnabled")

noclipButton = CreateButton(ButtonFrame2Left, "Noclip", function()
    if Config.NoclipEnabled then
        if noclipConnection then noclipConnection:Disconnect() end
        noclipConnection = RunService.Stepped:Connect(function()
            local char = LocalPlayer.Character
            if char and char:FindFirstChildOfClass("Humanoid") then
                for _, part in ipairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
    end
    sendNotification("NOCLIP", Config.NoclipEnabled and "ON" or "OFF")
end, "NoclipEnabled")

LocalPlayer.CharacterAdded:Connect(function()
    if Config.NoclipEnabled then
        task.wait(0.5)
        noclipConnection = RunService.Stepped:Connect(function()
            local char = LocalPlayer.Character
            if char and char:FindFirstChildOfClass("Humanoid") then
                for _, part in ipairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    end
end)

infiniteJumpButton = CreateButton(ButtonFrame2Left, "Infinite Jump", function()
    sendNotification("INFINITEJUMP", Config.infiniteJumpEnabled and "ON" or "OFF")
end, "infiniteJumpEnabled")

UserInputService.JumpRequest:Connect(function()
    if Config.infiniteJumpEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
        LocalPlayer.Character:FindFirstChildOfClass("Humanoid"):ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

antiAfkButton = CreateButton(ButtonFrame2Left, "Anti AFK", function()
    if Config.AntiAFKEnabled then
        antiAfkLoop = task.spawn(function()
            while Config.AntiAFKEnabled do
                task.wait(60)
                pcall(function()
                    local hum = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                    if hum then
                        hum:ChangeState(Enum.HumanoidStateType.Jumping)
                    end
                end)
            end
        end)
    else
        if antiAfkLoop then
            task.cancel(antiAfkLoop)
            antiAfkLoop = nil
        end
    end
    sendNotification("ANTI AFK", Config.AntiAFKEnabled and "ON" or "OFF")
end, "AntiAFKEnabled")

saveWaypointButton = CreateButton(ButtonFrame2Right, "Save Waypoint", function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        savedWaypoint = LocalPlayer.Character.HumanoidRootPart.CFrame
        sendNotification("Waypoint", "Đã lưu vị trí hiện tại!")
    else
        sendNotification("Waypoint", "Không thể lưu vị trí!")
    end
end, nil)

tpWaypointButton = CreateButton(ButtonFrame2Right, "TP to Waypoint", function()
    if savedWaypoint and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = savedWaypoint
        sendNotification("Waypoint", "Đã teleport tới vị trí đã lưu!")
    else
        sendNotification("Waypoint", "Chưa có vị trí được lưu!")
    end
end, nil)

local hiddenFling = false
local flingPower = 55000
local movel = 0.1

local function flingLoop()
    local lp = Players.LocalPlayer
    local hrp, c, vel

    task.spawn(function()
        while true do
            RunService.Heartbeat:Wait()
            if hiddenFling then
                while hiddenFling and not (c and c.Parent and hrp and hrp.Parent) do
                    RunService.Heartbeat:Wait()
                    c = lp.Character
                    hrp = c and c:FindFirstChild("HumanoidRootPart")
                end

                if hiddenFling and hrp then
                    vel = hrp.Velocity
                    hrp.Velocity = vel * flingPower + Vector3.new(0, flingPower, 0)
                    RunService.RenderStepped:Wait()
                    if hrp.Parent then
                        hrp.Velocity = vel
                    end
                    RunService.Stepped:Wait()
                    if hrp.Parent then
                        hrp.Velocity = vel + Vector3.new(0, movel, 0)
                        movel = movel * -1
                    end
                end
            end
        end
    end)
end

flingLoop()

flintTouchButton = CreateButton(ButtonFrame2Right, "FlintTouch", function()
    hiddenFling = not hiddenFling
    sendNotification("FLINGTOUCH", hiddenFling and "ON" or "OFF")
end, "FlintTouchEnabled")

flingAllButton = CreateButton(ButtonFrame2Right, "Fling All", function()
    hiddenFling = true
    flintTouchButton.Text = "FlintTouch: ON"
    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if myRoot then
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local targetRoot = plr.Character.HumanoidRootPart
                myRoot.CFrame = targetRoot.CFrame + Vector3.new(0, 0, -2)
                task.wait(0.1)
            end
        end
        sendNotification("Fling All", "Đã kích hoạt Fling All!")
    else
        sendNotification("Fling All", "Không tìm thấy nhân vật!")
    end
end, nil)

clickTpButton = CreateButton(ButtonFrame2Right, "Click TP", function()
    Config.clickTpEnabled = not Config.clickTpEnabled
    if Config.clickTpEnabled then
        if not clickTpTool then
            clickTpTool = Instance.new("Tool")
            clickTpTool.Name = "ClickTP"
            clickTpTool.RequiresHandle = false
            clickTpTool.Parent = LocalPlayer:WaitForChild("Backpack")
            clickTpTool.Activated:Connect(function()
                local mouse = LocalPlayer:GetMouse()
                local hit = mouse.Hit
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(hit.Position + Vector3.new(0, 3, 0))
                end
            end)
        end
        sendNotification("Click TP", "ON")
    else
        if clickTpTool then
            clickTpTool:Destroy()
            clickTpTool = nil
        end
        sendNotification("Click TP", "OFF")
    end
    SaveSettings()
end, "clickTpEnabled")

-- Hàm tạo danh sách người chơi
local function UpdatePlayerList()
    for _, v in ipairs(PlayerList:GetChildren()) do
        if v:IsA("Frame") then
            v:Destroy()
        end
    end
    Config.SelectedPlayers = Config.SelectedPlayers or {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, -10, 0, 25)
            frame.BackgroundTransparency = 1
            frame.Parent = PlayerList

            local toggle = Instance.new("TextButton")
            toggle.Size = UDim2.new(1, -25, 1, 0)
            toggle.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
            toggle.BackgroundTransparency = 0.2
            toggle.Text = plr.Name
            toggle.TextColor3 = Color3.fromRGB(0, 0, 0)
            toggle.TextSize = 14
            toggle.Font = Enum.Font.Gotham
            toggle.TextXAlignment = Enum.TextXAlignment.Left
            toggle.Parent = frame
            Instance.new("UICorner", toggle).CornerRadius = UDim.new(0, 6)
            animateButton(toggle)

            local check = Instance.new("ImageLabel")
            check.Size = UDim2.new(0, 20, 0, 20)
            check.Position = UDim2.new(1, -22, 0, 2)
            check.BackgroundTransparency = 1
            check.Image = Config.SelectedPlayers[plr.Name] and "rbxassetid://3926305904" or ""
            check.ImageRectOffset = Config.SelectedPlayers[plr.Name] and Vector2.new(524, 444) or Vector2.new(0, 0)
            check.ImageRectSize = Config.SelectedPlayers[plr.Name] and Vector2.new(36, 36) or Vector2.new(0, 0)
            check.Parent = frame

            toggle.MouseButton1Click:Connect(function()
                Config.SelectedPlayers[plr.Name] = not Config.SelectedPlayers[plr.Name]
                check.Image = Config.SelectedPlayers[plr.Name] and "rbxassetid://3926305904" or ""
                check.ImageRectOffset = Config.SelectedPlayers[plr.Name] and Vector2.new(524, 444) or Vector2.new(0, 0)
                check.ImageRectSize = Config.SelectedPlayers[plr.Name] and Vector2.new(36, 36) or Vector2.new(0, 0)
                SaveSettings()
            end)
        end
    end
end

Players.PlayerAdded:Connect(UpdatePlayerList)
Players.PlayerRemoving:Connect(function(plr)
    Config.SelectedPlayers[plr.Name] = nil
    UpdatePlayerList()
    SaveSettings()
end)
UpdatePlayerList()

-- Hàm kiểm tra mục tiêu hợp lệ cho ESP và Aimbot
local function IsValidTarget(plr)
    if plr == LocalPlayer then return false end
    if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") or not plr.Character:FindFirstChild("Humanoid") then return false end
    local bodyEffects = plr.Character:FindFirstChild("BodyEffects")
    local koValue = bodyEffects and bodyEffects:FindFirstChild("K.O")
    if Config.checkKOAimbot and koValue and koValue.Value then return false end
    return true
end

-- ESP
getgenv().ESPs = {}
local function CreateESP(plr)
    if plr == LocalPlayer then return end
    local esp = {}
    esp.label = Instance.new("BillboardGui")
    esp.label.Name = "SafeESP"
    esp.label.Size = UDim2.new(0, 100, 0, 30)
    esp.label.StudsOffset = Vector3.new(0, 3, 0)
    esp.label.AlwaysOnTop = true
    esp.label.Parent = plr.Character and plr.Character:FindFirstChild("Head")
    local text = Instance.new("TextLabel")
    text.Size = UDim2.new(1, 0, 1, 0)
    text.BackgroundTransparency = 1
    text.TextColor3 = Color3.fromRGB(255, 255, 255)
    text.TextStrokeTransparency = 0
    text.TextStrokeColor3 = Color3.new(0, 0, 0)
    text.TextSize = 14
    text.Font = Enum.Font.Gotham
    text.Text = plr.Name
    text.Parent = esp.label

    esp.highlight = Instance.new("Highlight")
    esp.highlight.Adornee = plr.Character
    esp.highlight.FillColor = Color3.fromRGB(255, 255, 255)
    esp.highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    esp.highlight.FillTransparency = 0.5
    esp.highlight.OutlineTransparency = 0
    esp.highlight.Parent = plr.Character

    getgenv().ESPs[plr.Name] = esp

    local function UpdateESP()
        if not plr.Character or not plr.Character:FindFirstChild("Head") or not Config.ESPEnabled then
            esp.label.Enabled = false
            esp.highlight.Enabled = false
            return
        end
        local bodyEffects = plr.Character:FindFirstChild("BodyEffects")
        local koValue = bodyEffects and bodyEffects:FindFirstChild("K.O")
        if koValue and koValue.Value then
            esp.highlight.FillColor = Color3.fromRGB(135, 206, 250) -- Xanh dương nhạt cho người K.O.
        else
            esp.highlight.FillColor = Color3.fromRGB(255, 255, 255)
        end
        esp.label.Enabled = true
        esp.highlight.Enabled = true
        esp.label.Adornee = plr.Character:FindFirstChild("Head")
    end

    esp.connection = RunService.RenderStepped:Connect(UpdateESP)
    table.insert(getgenv().Connections, esp.connection)
end

local function RemoveESP(plr)
    if getgenv().ESPs[plr.Name] then
        if getgenv().ESPs[plr.Name].label then
            getgenv().ESPs[plr.Name].label:Destroy()
        end
        if getgenv().ESPs[plr.Name].highlight then
            getgenv().ESPs[plr.Name].highlight:Destroy()
        end
        if getgenv().ESPs[plr.Name].connection then
            getgenv().ESPs[plr.Name].connection:Disconnect()
        end
        getgenv().ESPs[plr.Name] = nil
    end
end

Players.PlayerAdded:Connect(function(plr)
    if Config.ESPEnabled then
        CreateESP(plr)
    end
end)

Players.PlayerRemoving:Connect(RemoveESP)

for _, plr in ipairs(Players:GetPlayers()) do
    if Config.ESPEnabled then
        CreateESP(plr)
    end
end

-- ESP Loop
task.spawn(function()
    while true do
        if Config.ESPEnabled then
            for _, plr in ipairs(Players:GetPlayers()) do
                if not getgenv().ESPs[plr.Name] then
                    CreateESP(plr)
                end
            end
        else
            for _, plr in ipairs(Players:GetPlayers()) do
                RemoveESP(plr)
            end
        end
        task.wait(1)
    end
end)

-- Speed Hack
task.spawn(function()
    while true do
        if Config.SpeedEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
            local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            hum.WalkSpeed = Config.SpeedAmount
        elseif LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
            local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            hum.WalkSpeed = 16
        end
        task.wait(0.1)
    end
end)

-- Fly Hack
local function Fly()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local root = char.HumanoidRootPart
    local bodyGyro = Instance.new("BodyGyro")
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyGyro.P = 9e4
    bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bodyGyro.CFrame = root.CFrame
    bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bodyVelocity.Velocity = Vector3.new(0, 0.1, 0)
    bodyGyro.Parent = root
    bodyVelocity.Parent = root

    local speed = Config.FlySpeed
    local cam = Workspace.CurrentCamera
    local input = {F = 0, B = 0, L = 0, R = 0, U = 0, D = 0}

    local function updateFly()
        local look = (cam.CoordinateFrame.LookVector * Vector3.new(1, 0, 1)).Unit
        local right = (cam.CoordinateFrame.RightVector * Vector3.new(1, 0, 1)).Unit
        local up = Vector3.new(0, 1, 0)
        local moveDir = (look * (input.F - input.B) + right * (input.R - input.L) + up * (input.U - input.D)).Unit
        bodyVelocity.Velocity = moveDir * speed
        bodyGyro.CFrame = cam.CoordinateFrame
    end

    local flyConnection
    flyConnection = RunService.RenderStepped:Connect(function()
        if not Config.FlyEnabled or not char or not char.Parent or not root.Parent then
            bodyGyro:Destroy()
            bodyVelocity:Destroy()
            flyConnection:Disconnect()
            return
        end
        updateFly()
    end)

    local inputBegan = UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == Enum.KeyCode.W then input.F = 1
        elseif input.KeyCode == Enum.KeyCode.S then input.B = 1
        elseif input.KeyCode == Enum.KeyCode.A then input.L = 1
        elseif input.KeyCode == Enum.KeyCode.D then input.R = 1
        elseif input.KeyCode == Enum.KeyCode.Space then input.U = 1
        elseif input.KeyCode == Enum.KeyCode.LeftControl then input.D = 1
        end
        updateFly()
    end)

    local inputEnded = UserInputService.InputEnded:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.W then input.F = 0
        elseif input.KeyCode == Enum.KeyCode.S then input.B = 0
        elseif input.KeyCode == Enum.KeyCode.A then input.L = 0
        elseif input.KeyCode == Enum.KeyCode.D then input.R = 0
        elseif input.KeyCode == Enum.KeyCode.Space then input.U = 0
        elseif input.KeyCode == Enum.KeyCode.LeftControl then input.D = 0
        end
        updateFly()
    end)

    table.insert(getgenv().Connections, flyConnection)
    table.insert(getgenv().Connections, inputBegan)
    table.insert(getgenv().Connections, inputEnded)
end

LocalPlayer.CharacterAdded:Connect(function()
    if Config.FlyEnabled then
        task.wait(0.5)
        Fly()
    end
end)

task.spawn(function()
    while true do
        if Config.FlyEnabled then
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                Fly()
            end
        end
        task.wait(1)
    end
end)

-- Aimbot
local function GetClosestPlayer()
    local closestPlayer = nil
    local minDist = fovRadius
    local mousePos = UserInputService:GetMouseLocation()

    for _, plr in ipairs(Players:GetPlayers()) do
        if IsValidTarget(plr) and Config.SelectedPlayers[plr.Name] then
            local root = plr.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local screenPos, onScreen = Camera:WorldToViewportPoint(root.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(mousePos.X, mousePos.Y)).Magnitude
                    if dist < minDist then
                        minDist = dist
                        closestPlayer = plr
                    end
                end
            end
        end
    end
    return closestPlayer
end

local aimbotConnection
task.spawn(function()
    while true do
        if Config.AimbotEnabled then
            local closest = GetClosestPlayer()
            if closest and closest.Character and closest.Character:FindFirstChild("HumanoidRootPart") then
                local targetPos = closest.Character.HumanoidRootPart.Position
                Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetPos)
            end
        end
        task.wait()
    end
end)

-- TriggerBot
local triggerBotConnection
task.spawn(function()
    while true do
        if tbEnabled then
            local mouse = LocalPlayer:GetMouse()
            local target = mouse.Target
            if target and target.Parent then
                local char = target.Parent
                local plr = Players:GetPlayerFromCharacter(char)
                if plr and IsValidTarget(plr) and Config.SelectedPlayers[plr.Name] then
                    mouse1press()
                    task.wait(0.05)
                    mouse1release()
                end
            end
        end
        task.wait(0.1)
    end
end)

-- InstantStomp
task.spawn(function()
    while true do
        if Config.NoStompAnimEnabled then
            local char = LocalPlayer.Character
            local hum = char and char:FindFirstChildOfClass("Humanoid")
            if hum and hum:GetState() == Enum.HumanoidStateType.Landed then
                for _, plr in ipairs(Players:GetPlayers()) do
                    if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("BodyEffects") then
                        local bodyEffects = plr.Character.BodyEffects
                        local koValue = bodyEffects:FindFirstChild("K.O")
                        if koValue and koValue.Value then
                            local root = char:FindFirstChild("HumanoidRootPart")
                            local targetRoot = plr.Character:FindFirstChild("Torso") or plr.Character:FindFirstChild("HumanoidRootPart")
                            if root and targetRoot and (root.Position - targetRoot.Position).Magnitude < 5 then
                                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                                task.wait(0.05)
                                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                            end
                        end
                    end
                end
            end
        end
        task.wait(0.05)
    end
end)

-- Đảm bảo tất cả các nút hiển thị trạng thái chính xác
local function UpdateButtonStates()
    espButton.Text = "ESP: " .. (Config.ESPEnabled and "ON" or "OFF")
    speedButton.Text = "Speed: " .. (Config.SpeedEnabled and "ON" or "OFF")
    flyButton.Text = "Fly: " .. (Config.FlyEnabled and "ON" or "OFF")
    aimbotButton.Text = "Aimbot: " .. (Config.AimbotEnabled and "ON" or "OFF")
    checkKOAimbotButton.Text = "Check K.O Aimbot: " .. (Config.checkKOAimbot and "ON" or "OFF")
    triggerBotButton.Text = "TriggerBot: " .. (tbEnabled and "ON" or "OFF")
    autoKillButton.Text = "AutoKill: " .. (Config.AutoKillEnabled and "ON" or "OFF")
    antiLockButton.Text = "AntiLock: " .. (Config.AntiLockEnabled and "ON" or "OFF")
    autoStompButton.Text = "AutoStomp: " .. (Config.AutoStompEnabled and "ON" or "OFF")
    antiStompButton.Text = "AntiStomp: " .. (Config.AntiStompEnabled and "ON" or "OFF")
    instantStompButton.Text = "InstantStomp: " .. (Config.NoStompAnimEnabled and "ON" or "OFF")
    instantReloadButton.Text = "InstantReload: " .. (Config.AutoReloadEnabled and "ON" or "OFF")
    customFovButton.Text = "Custom FOV: " .. (Config.CustomFovEnabled and "ON" or "OFF")
    fullbrightButton.Text = "Fullbright: " .. (Config.FullbrightEnabled and "ON" or "OFF")
    noclipButton.Text = "Noclip: " .. (Config.NoclipEnabled and "ON" or "OFF")
    infiniteJumpButton.Text = "Infinite Jump: " .. (Config.infiniteJumpEnabled and "ON" or "OFF")
    antiAfkButton.Text = "Anti AFK: " .. (Config.AntiAFKEnabled and "ON" or "OFF")
    flintTouchButton.Text = "FlintTouch: " .. (hiddenFling and "ON" or "OFF")
    clickTpButton.Text = "Click TP: " .. (Config.clickTpEnabled and "ON" or "OFF")
end

-- Cập nhật trạng thái nút khi tải
UpdateButtonStates()

-- Lưu config khi thoát game
game:BindToClose(function()
    SaveSettings()
end)

-- Thông báo script đã load
sendNotification("DhuyxDtuyen", "Script đã load thành công!")
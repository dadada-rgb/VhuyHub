local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Cấu hình
local Config = {
    CamlockRange = 500, -- Phạm vi camlock
    CamlockPart = "HumanoidRootPart", -- Phần nhắm
    CamlockEnabled = false, -- Trạng thái camlock
    CamlockTarget = nil, -- Mục tiêu camlock
    ESPEnabled = false, -- Trạng thái ESP
    ZoomEnabled = false, -- Trạng thái zoom
    ShiftAmount = 0.5, -- Độ dịch chuyển antilock
    SelectedPlayers = {}, -- Danh sách người chơi được chọn
    TriggerbotEnabled = false, -- Trạng thái triggerbot
    TriggerFOV = 20, -- Phạm vi FOV triggerbot
    Prediction = { X = 0.165, Y = 0.1 } -- Prediction cho camlock
}

-- Danh sách phần hợp lệ
local ValidParts = {"Head", "HumanoidRootPart"}

-- Khởi tạo ScreenGui cho ESP
local espGui = Instance.new("ScreenGui")
espGui.Name = "SafeESP"
espGui.ResetOnSpawn = false
espGui.IgnoreGuiInset = true
espGui.Parent = PlayerGui

-- Khởi tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = tostring(math.random(1e6, 1e7))
ScreenGui.ResetOnSpawn = false
ScreenGui.Enabled = true
ScreenGui.Parent = PlayerGui

local MenuFrame = Instance.new("Frame")
MenuFrame.Size = UDim2.new(0, 120, 0, 160)
MenuFrame.Position = UDim2.new(0.1, 0, 0.3, 0)
MenuFrame.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
MenuFrame.BackgroundTransparency = 0
MenuFrame.Active = true
MenuFrame.Draggable = true
MenuFrame.Parent = ScreenGui
Instance.new("UICorner", MenuFrame).CornerRadius = UDim.new(0, 8)

local MenuTitle = Instance.new("TextLabel")
MenuTitle.Size = UDim2.new(1, 0, 0, 18)
MenuTitle.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
MenuTitle.Text = "VhuyHub"
MenuTitle.TextColor3 = Color3.fromRGB(0, 0, 0)
MenuTitle.Font = Enum.Font.SourceSans
MenuTitle.TextSize = 12
MenuTitle.Parent = MenuFrame
Instance.new("UICorner", MenuTitle).CornerRadius = UDim.new(0, 8)

local PlayerList = Instance.new("ScrollingFrame")
PlayerList.Size = UDim2.new(1, -4, 1, -22)
PlayerList.Position = UDim2.new(0, 2, 0, 20)
PlayerList.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayerList.ScrollBarThickness = 3
PlayerList.BackgroundTransparency = 1
PlayerList.Parent = MenuFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 3)
UIListLayout.Parent = PlayerList
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    PlayerList.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y)
end)

-- Danh sách ESP
local ESPs = {}

-- Kiểm tra phần hợp lệ
local function IsValidPart(part)
    if not part or not part.Parent or not part.Parent:FindFirstChild("Humanoid") then return false end
    for _, name in ipairs(ValidParts) do
        if part.Name:lower() == name:lower() then return true end
    end
    return false
end

-- Kiểm tra trạng thái người chơi
local function IsValidTarget(player)
    if not player or not player.Character or not player.Character:FindFirstChild("Humanoid") or not player.Character:FindFirstChild("HumanoidRootPart") then return false end
    local bodyEffects = player.Character:FindFirstChild("BodyEffects")
    local isKO = bodyEffects and bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
    local isGrabbed = player.Character:FindFirstChild("GRABBING_CONSTRAINT") ~= nil
    return not (isKO or isGrabbed)
end

-- Tạo ESP
local function CreateESP(player)
    if ESPs[player] or player == LocalPlayer then return end
    local label = Instance.new("TextLabel")
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(200, 200, 200)
    label.TextSize = 14
    label.Font = Enum.Font.GothamBlack
    label.Text = player.DisplayName
    label.TextStrokeTransparency = 0.7
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    label.Size = UDim2.new(0, 200, 0, 20)
    label.AnchorPoint = Vector2.new(0.5, 0.5)
    label.Position = UDim2.new(0.5, 0, 0.5, 0)
    label.Visible = false
    label.Parent = espGui

    local highlight = Instance.new("Highlight")
    highlight.Enabled = false
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0.3
    highlight.FillColor = Color3.fromRGB(200, 200, 200)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.Adornee = player.Character
    highlight.Parent = espGui

    ESPs[player] = { label = label, highlight = highlight }
end

-- Xóa ESP
local function RemoveESP(player)
    if ESPs[player] then
        pcall(function()
            ESPs[player].label:Destroy()
            ESPs[player].highlight:Destroy()
        end)
        ESPs[player] = nil
    end
end

-- Cập nhật ESP
local function UpdateESP()
    if not Config.ESPEnabled then
        for _, v in pairs(ESPs) do
            v.label.Visible = false
            v.highlight.Enabled = false
        end
        return
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and IsValidTarget(player) then
            local character = player.Character
            local head = character:FindFirstChild("Head")
            if head then
                CreateESP(player)
                local headPos = head.Position
                local screenPos, onScreen = Camera:WorldToViewportPoint(headPos)
                local esp = ESPs[player]
                if esp then
                    local isSelected = Config.SelectedPlayers[player.Name]
                    esp.label.TextColor3 = isSelected and Color3.fromRGB(255, 179, 186) or Color3.fromRGB(200, 200, 200)
                    esp.highlight.FillColor = isSelected and Color3.fromRGB(255, 179, 186) or Color3.fromRGB(200, 200, 200)
                    if onScreen then
                        esp.label.Visible = true
                        esp.label.Position = UDim2.new(0, screenPos.X, 0, screenPos.Y - 20)
                        esp.highlight.Enabled = true
                    else
                        esp.label.Visible = false
                        esp.highlight.Enabled = false
                    end
                end
            else
                RemoveESP(player)
            end
        else
            RemoveESP(player)
        end
    end
end

-- Tìm mục tiêu camlock
local function GetClosestPlayer()
    local ClosestDistance, ClosestPlayer = 100000, nil
    for _, player in pairs(Players:GetPlayers()) do
        if player.Name ~= LocalPlayer.Name and IsValidTarget(player) and Config.SelectedPlayers[player.Name] then
            local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local rootPos, visible = Camera:WorldToScreenPoint(root.Position)
                if not visible then
                    continue
                end
                local distance = (Vector2.new(Mouse.X, Mouse.Y) - Vector2.new(rootPos.X, rootPos.Y)).Magnitude
                if distance < ClosestDistance then
                    ClosestPlayer = player
                    ClosestDistance = distance
                end
            end
        end
    end
    return ClosestPlayer
end

-- Camlock với prediction
local function Camlock()
    if not Config.CamlockEnabled or not Config.CamlockTarget then return end
    local hitpart = Config.CamlockTarget.Character and Config.CamlockTarget.Character:FindFirstChild(Config.CamlockPart)
    if not hitpart then
        Config.CamlockTarget = nil
        return
    end
    local predictedPos = hitpart.Position + hitpart.Velocity * Vector3.new(Config.Prediction.X, Config.Prediction.Y, Config.Prediction.X)
    Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPos)
end

-- Antilock (luôn hoạt động)
local function UpdateAntilock()
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local root = character.HumanoidRootPart
        root.CFrame = root.CFrame * CFrame.new(math.random(-Config.ShiftAmount, Config.ShiftAmount)/50, 0, math.random(-Config.ShiftAmount, Config.ShiftAmount)/50)
    end
end

-- Zoom (chuyển đổi góc nhìn)
local function UpdateZoom()
    if Config.ZoomEnabled then
        LocalPlayer.CameraMode = Enum.CameraMode.LockFirstPerson
        LocalPlayer.CameraMinZoomDistance = 0.5
    else
        LocalPlayer.CameraMode = Enum.CameraMode.Classic
        LocalPlayer.CameraMinZoomDistance = 0.5
    end
end

-- Triggerbot (bắn liên tục, không cooldown)
local function Triggerbot()
    if not Config.TriggerbotEnabled then return end
    local target = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool") and LocalPlayer:GetMouse().Target
    if target and IsValidPart(target) then
        local screenPos, onScreen = Camera:WorldToViewportPoint(target.Position)
        if onScreen then
            local mousePos = UserInputService:GetMouseLocation()
            local distance = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
            if distance <= Config.TriggerFOV then
                task.spawn(function()
                    local mousePos = UserInputService:GetMouseLocation()
                    VirtualInputManager:SendMouseButtonEvent(mousePos.X, mousePos.Y, 0, true, game, 0)
                    task.wait(math.random(80, 120) / 1000)
                    VirtualInputManager:SendMouseButtonEvent(mousePos.X, mousePos.Y, 0, false, game, 0)
                end)
            end
        end
    end
end

-- Cập nhật danh sách người chơi
local function UpdatePlayerList()
    for _, cd in pairs(PlayerList:GetChildren()) do
        if cd:IsA("TextButton") then cd:Destroy() end
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local button = Instance.new("TextButton")
            button.Size = UDim2.new(1, -4, 0, 18)
            button.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            button.BackgroundTransparency = 0.2
            button.TextColor3 = Color3.fromRGB(0, 0, 0)
            button.TextSize = 12
            button.Font = Enum.Font.SourceSans
            button.AutoButtonColor = false
            button.Parent = PlayerList
            local function UpdateButtonText()
                local isSelected = Config.SelectedPlayers[player.Name]
                button.Text = (isSelected and "✓ " or "") .. player.DisplayName
            end
            button.MouseButton1Click:Connect(function()
                Config.SelectedPlayers[player.Name] = not Config.SelectedPlayers[player.Name]
                UpdateButtonText()
            end)
            UpdateButtonText()
        end
    end
end

-- Xử lý input
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.RightShift then
        ScreenGui.Enabled = not ScreenGui.Enabled
    elseif input.KeyCode == Enum.KeyCode.K then
        Config.ESPEnabled = not Config.ESPEnabled
    elseif input.KeyCode == Enum.KeyCode.X then
        Config.ZoomEnabled = true
        UpdateZoom()
    elseif input.UserInputType == Enum.UserInputType.MouseButton2 then
        Config.TriggerbotEnabled = true
    elseif input.UserInputType == Enum.UserInputType.MouseButton3 then
        local target = LocalPlayer:GetMouse().Target
        if IsValidPart(target) then
            local targetPlayer = Players:GetPlayerFromCharacter(target.Parent)
            if targetPlayer and targetPlayer ~= LocalPlayer then
                Config.SelectedPlayers[targetPlayer.Name] = not Config.SelectedPlayers[targetPlayer.Name]
                UpdatePlayerList()
            end
        end
    elseif input.KeyCode == Enum.KeyCode.T then
        local autoSelect = not autoSelect
        if autoSelect then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    Config.SelectedPlayers[player.Name] = true
                end
            end
        else
            Config.SelectedPlayers = {}
        end
        UpdatePlayerList()
    elseif input.KeyCode == Enum.KeyCode.C then
        Config.CamlockEnabled = not Config.CamlockEnabled
        Config.CamlockTarget = Config.CamlockEnabled and GetClosestPlayer() or nil
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        Config.TriggerbotEnabled = false
    elseif input.KeyCode == Enum.KeyCode.X then
        Config.ZoomEnabled = false
        UpdateZoom()
    end
end)

-- Xử lý sự kiện người chơi
local Connections = {}
local function Connect(event, callback)
    local connection = event:Connect(callback)
    table.insert(Connections, connection)
    return connection
end

Connect(Players.PlayerAdded, function(player)
    task.wait(math.random(2, 3))
    RemoveESP(player)
    UpdatePlayerList()
end)

Connect(Players.PlayerRemoving, function(player)
    RemoveESP(player)
    Config.SelectedPlayers[player.Name] = nil
    if Config.CamlockTarget == player then
        Config.CamlockTarget = nil
        Config.CamlockEnabled = false
    end
    UpdatePlayerList()
end)

Connect(RunService.RenderStepped, UpdateESP)

-- Vòng lặp chính
RunService.RenderStepped:Connect(function()
    UpdateAntilock()
    UpdateZoom()
    if Config.CamlockEnabled then
        Camlock()
    end
    if Config.TriggerbotEnabled then
        Triggerbot()
    end
end)

-- Cập nhật danh sách người chơi định kỳ
task.spawn(function()
    while true do
        UpdatePlayerList()
        task.wait(math.random(12, 15))
    end
end)

-- Dọn dẹp khi thoát
game:BindToClose(function()
    for _, connection in pairs(Connections) do
        pcall(function() connection:Disconnect() end)
    end
    for _, esp in pairs(ESPs) do
        pcall(function()
            esp.label:Destroy()
            esp.highlight:Destroy()
        end)
    end
    pcall(function() if ScreenGui and ScreenGui.Parent then ScreenGui:Destroy() end end)
    pcall(function() if espGui and espGui.Parent then espGui:Destroy() end end)
end)

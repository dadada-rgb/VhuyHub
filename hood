local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Cấu hình
local Config = {
    ESPEnabled = true, -- Trạng thái ESP
    ShiftAmount = 0.5, -- Độ dịch chuyển antilock
    SelectedPlayers = {} -- Danh sách người chơi được chọn
}

local autoSelect = false 

local PlayerGui = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
local getgenv = getgenv or _G

-- Khởi tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = tostring(math.random(1e6, 1e7))
ScreenGui.ResetOnSpawn = false
ScreenGui.Enabled = true
ScreenGui.Parent = PlayerGui

local MenuFrame = Instance.new("Frame")
MenuFrame.Size = UDim2.new(0, 120, 0, 160)
MenuFrame.Position = UDim2.new(0.1, 0, 0.3, 0)
MenuFrame.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
MenuFrame.BackgroundTransparency = 0
MenuFrame.Active = true
MenuFrame.Draggable = true
MenuFrame.Parent = ScreenGui
Instance.new("UICorner", MenuFrame).CornerRadius = UDim.new(0, 8)

-- Thanh tiêu đề (dùng làm nơi đặt ô nhập pred)
local TitleFrame = Instance.new("Frame")
TitleFrame.Size = UDim2.new(1, 0, 0, 24)
TitleFrame.BackgroundColor3 = Color3.fromRGB(255, 179, 186)
TitleFrame.BorderSizePixel = 0
TitleFrame.Parent = MenuFrame
Instance.new("UICorner", TitleFrame).CornerRadius = UDim.new(0, 8)

-- TextBox Pred X
local predictionXBox = Instance.new("TextBox")
predictionXBox.Size = UDim2.new(0.5, -4, 1, -6)
predictionXBox.Position = UDim2.new(0, 2, 0, 3)
predictionXBox.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
predictionXBox.TextColor3 = Color3.new(1, 1, 1)
predictionXBox.Font = Enum.Font.SourceSans
predictionXBox.TextSize = 12
predictionXBox.PlaceholderText = "Pred X"
predictionXBox.Text = tostring(getgenv().Aimbot and getgenv().Aimbot.Prediction.X or "0.165")
predictionXBox.ClearTextOnFocus = false
predictionXBox.Parent = TitleFrame

-- TextBox Pred Y
local predictionYBox = predictionXBox:Clone()
predictionYBox.Position = UDim2.new(0.5, 2, 0, 3)
predictionYBox.PlaceholderText = "Pred Y"
predictionYBox.Text = tostring(getgenv().Aimbot and getgenv().Aimbot.Prediction.Y or "0.1")
predictionYBox.Parent = TitleFrame

-- Update pred value khi mất focus
predictionXBox.FocusLost:Connect(function()
	local val = tonumber(predictionXBox.Text)
	if val then
		getgenv().Aimbot.Prediction.X = val
	end
end)
predictionYBox.FocusLost:Connect(function()
	local val = tonumber(predictionYBox.Text)
	if val then
		getgenv().Aimbot.Prediction.Y = val
	end
end)

-- Danh sách người chơi
local PlayerList = Instance.new("ScrollingFrame")
PlayerList.Size = UDim2.new(1, -4, 1, -30)
PlayerList.Position = UDim2.new(0, 2, 0, 26)
PlayerList.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayerList.ScrollBarThickness = 3
PlayerList.BackgroundTransparency = 1
PlayerList.Parent = MenuFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 3)
UIListLayout.Parent = PlayerList
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	PlayerList.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y)
end)


-- Danh sách ESP
local ESPs = {}

-- Kiểm tra trạng thái người chơi
local function IsValidTarget(player)
    if not player or not player.Character or not player.Character:FindFirstChild("Humanoid") or not player.Character:FindFirstChild("HumanoidRootPart") then return false end
    local bodyEffects = player.Character:FindFirstChild("BodyEffects")
    local isKO = bodyEffects and bodyEffects:FindFirstChild("K.O") and bodyEffects["K.O"].Value
    local isGrabbed = player.Character:FindFirstChild("GRABBING_CONSTRAINT") ~= nil
    return not (isKO or isGrabbed)
end

-- Đảm bảo espGui được khởi tạo
local espGui = Instance.new("ScreenGui")
espGui.Name = "ESPGui"
espGui.Parent = PlayerGui

-- Tạo ESP
local function CreateESP(player)
    if ESPs[player] or player == LocalPlayer then return end
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = player.Name .. "_ESP"
    billboardGui.Adornee = player.Character and player.Character:FindFirstChild("Head")
    billboardGui.Size = UDim2.new(0, 200, 0, 50)
    billboardGui.StudsOffset = Vector3.new(0, 2, 0) -- Đặt trên đầu 2 đơn vị
    billboardGui.AlwaysOnTop = true
    billboardGui.Parent = espGui

    local label = Instance.new("TextLabel")
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(200, 200, 200)
    label.TextSize = 14
    label.Font = Enum.Font.GothamBlack
    label.Text = player.DisplayName
    label.TextStrokeTransparency = 0.7
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Parent = billboardGui

    local highlight = Instance.new("Highlight")
    highlight.Enabled = false
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0.3
    highlight.FillColor = Color3.fromRGB(200, 200, 200)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.Adornee = player.Character
    highlight.Parent = espGui

    ESPs[player] = { billboardGui = billboardGui, label = label, highlight = highlight }
end

-- Xóa ESP
local function RemoveESP(player)
    if ESPs[player] then
        pcall(function()
            ESPs[player].billboardGui:Destroy()
            ESPs[player].highlight:Destroy()
        end)
        ESPs[player] = nil
    end
end

-- Cập nhật ESP
local function UpdateESP()
    if not Config.ESPEnabled then
        print("ESP is disabled")
        for _, v in pairs(ESPs) do
            v.billboardGui.Enabled = false
            v.highlight.Enabled = false
        end
        return
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and IsValidTarget(player) then
            local character = player.Character
            local head = character and character:FindFirstChild("Head")
            if head then
                if not ESPs[player] then
                    print("Creating ESP for: ", player.Name)
                    CreateESP(player)
                end
                local esp = ESPs[player]
                if esp then
                    local isSelected = Config.SelectedPlayers[player.Name]
                    esp.label.TextColor3 = isSelected and Color3.fromRGB(255, 179, 186) or Color3.fromRGB(200, 200, 200)
                    esp.highlight.FillColor = isSelected and Color3.fromRGB(255, 179, 186) or Color3.fromRGB(200, 200, 200)
                    esp.billboardGui.Adornee = head -- Cập nhật Adornee
                    esp.highlight.Adornee = character -- Cập nhật Adornee cho highlight
                    esp.billboardGui.Enabled = true
                    esp.highlight.Enabled = true
                    print("ESP enabled for: ", player.Name)
                end
            else
                print("No Head for: ", player.Name)
                RemoveESP(player)
            end
        else
            RemoveESP(player)
        end
    end
end

-- Xử lý respawn cho người chơi
for _, player in ipairs(Players:GetPlayers()) do
    Connect(player.CharacterAdded, function(character)
        print("Character respawned for: ", player.Name)
        RemoveESP(player)
        if player ~= LocalPlayer and IsValidTarget(player) then
            CreateESP(player)
        end
        UpdatePlayerList()
    end)
end

-- Xử lý respawn của LocalPlayer
Connect(LocalPlayer.CharacterAdded, function(character)
    print("LocalPlayer respawned")
    -- Làm mới ESP cho tất cả người chơi
    for _, player in ipairs(Players:GetPlayers()) do
        RemoveESP(player)
    end
    UpdateESP()
end)

-- Cập nhật sự kiện PlayerAdded
Connect(Players.PlayerAdded, function(player)
    task.wait(math.random(2, 3))
    RemoveESP(player)
    UpdatePlayerList()
    -- Thêm sự kiện CharacterAdded cho người chơi mới
    player.CharacterAdded:Connect(function(character)
        print("Character added for: ", player.Name)
        RemoveESP(player)
        if player ~= LocalPlayer and IsValidTarget(player) then
            CreateESP(player)
        end
        UpdatePlayerList()
    end)
end)

-- Antilock (luôn hoạt động)
local function UpdateAntilock()
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local root = character.HumanoidRootPart
        root.CFrame = root.CFrame * CFrame.new(math.random(-Config.ShiftAmount, Config.ShiftAmount)/50, 0, math.random(-Config.ShiftAmount, Config.ShiftAmount)/50)
    end
end

-- Macro Zoom kiểu lock/unlock camera nhanh khi nhấn giữ phím X (hoặc DPadDown trên mobile gamepad)
local macroEnabled = false

UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.X or input.KeyCode == Enum.KeyCode.DPadDown then
		macroEnabled = true
	end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.X or input.KeyCode == Enum.KeyCode.DPadDown then
		macroEnabled = false
	end
end)

RunService.Heartbeat:Connect(function()
	local player = Players.LocalPlayer
	if macroEnabled then
		player.CameraMinZoomDistance = 0.5
		player.CameraMode = Enum.CameraMode.LockFirstPerson
		task.wait() -- nhanh như heartbeat
		player.CameraMode = Enum.CameraMode.Classic
		player.CameraMinZoomDistance = 5
		task.wait()
	else
		player.CameraMinZoomDistance = 0.5
		player.CameraMode = Enum.CameraMode.Classic
	end
end)

-- Cập nhật danh sách người chơi
local function UpdatePlayerList()
    for _, cd in pairs(PlayerList:GetChildren()) do
        if cd:IsA("TextButton") then cd:Destroy() end
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local button = Instance.new("TextButton")
            button.Size = UDim2.new(1, -4, 0, 18)
            button.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            button.BackgroundTransparency = 0.2
            button.TextColor3 = Color3.fromRGB(0, 0, 0)
            button.TextSize = 12
            button.Font = Enum.Font.SourceSans
            button.AutoButtonColor = false
            button.Parent = PlayerList
            local function UpdateButtonText()
                local isSelected = Config.SelectedPlayers[player.Name]
                button.Text = (isSelected and "✓ " or "") .. player.DisplayName
            end
            button.MouseButton1Click:Connect(function()
                Config.SelectedPlayers[player.Name] = not Config.SelectedPlayers[player.Name]
                UpdateButtonText()
            end)
            UpdateButtonText()
        end
    end
end

-- Xử lý input
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.RightShift then
        ScreenGui.Enabled = not ScreenGui.Enabled
    elseif input.KeyCode == Enum.KeyCode.K then
        Config.ESPEnabled = not Config.ESPEnabled
    elseif input.KeyCode == Enum.KeyCode.X then
        Config.ZoomEnabled = true
        UpdateZoom()
    elseif input.KeyCode == Enum.KeyCode.T then
        autoSelect = not autoSelect
        if autoSelect then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    Config.SelectedPlayers[player.Name] = true
                end
            end
        else
            Config.SelectedPlayers = {}
        end
        UpdatePlayerList()
    end
end)

-- Xử lý sự kiện người chơi
local Connections = {}
local function Connect(event, callback)
    local connection = event:Connect(callback)
    table.insert(Connections, connection)
    return connection
end

Connect(Players.PlayerAdded, function(player)
    task.wait(math.random(2, 3))
    RemoveESP(player)
    UpdatePlayerList()
end)

Connect(Players.PlayerRemoving, function(player)
    RemoveESP(player)
    Config.SelectedPlayers[player.Name] = nil
    UpdatePlayerList()
end)

Connect(RunService.RenderStepped, UpdateESP)

-- Vòng lặp chính
RunService.RenderStepped:Connect(function()
    UpdateAntilock()
    UpdateZoom()
end)

-- Cập nhật danh sách người chơi định kỳ
task.spawn(function()
    while true do
        UpdatePlayerList()
        task.wait(math.random(12, 15))
    end
end)

-- Antilock luôn hoạt động
local function AntilockStep()
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local root = character.HumanoidRootPart
        local offsetX = math.random(-5, 5) / 100
        local offsetZ = math.random(-5, 5) / 100
        root.CFrame = root.CFrame * CFrame.new(offsetX, 0, offsetZ)
    end
end

local Players, UIS, Run, VU = game:GetService("Players"), game:GetService("UserInputService"), game:GetService("RunService"), game:GetService("VirtualUser")
local LP, Mouse, Cam = Players.LocalPlayer, Players.LocalPlayer:GetMouse(), workspace.CurrentCamera

local tbEnabled = true -- TriggerBot luôn hoạt động
local predictionTime = 0
local fovRadius = 20
local hitParts = {
    "Head",
    "HumanoidRootPart",
    "UpperTorso",
    "LowerTorso",
    "LeftUpperArm",
    "LeftLowerArm",
    "LeftHand",
    "RightUpperArm",
    "RightLowerArm",
    "RightHand",
    "LeftUpperLeg",
    "LeftLowerLeg",
    "LeftFoot",
    "RightUpperLeg",
    "RightLowerLeg",
    "RightFoot",
    "Torso",
    "Left Arm",
    "Right Arm",
    "Left Leg",
    "Right Leg"
}

-- Kiểm tra target có hợp lệ không
local function validPart(p)
    if not p or not p.Parent or not p.Parent:FindFirstChild("Humanoid") then return false end
    local player = Players:GetPlayerFromCharacter(p.Parent)
    if not player or not Config.SelectedPlayers[player.Name] then return false end
    for _, n in ipairs(hitParts) do
        if p.Name:lower() == n:lower() then return true end
    end
    return false
end

-- Tính khoảng cách từ chuột tới part
local function distToCursor(part)
    local v, vis = Cam:WorldToViewportPoint(part.Position)
    if not vis then return math.huge end
    local m = UIS:GetMouseLocation()
    return (Vector2.new(v.X, v.Y) - Vector2.new(m.X, m.Y)).Magnitude
end

-- Click chuột trái
local function click()
    if mouse1press then 
        mouse1press() 
        mouse1release()
    elseif mouse1click then 
        mouse1click()
    else
        VU:Button1Down(Vector2.new(), Cam.CFrame)
        task.wait()
        VU:Button1Up(Vector2.new(), Cam.CFrame)
    end
end

local function GetBestTargetPart()
    local bestPart, bestDist = nil, fovRadius
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LP and Config.SelectedPlayers[plr.Name] and plr.Character then
            for _, partName in ipairs(hitParts) do
                local part = plr.Character:FindFirstChild(partName)
                if part and part:IsA("BasePart") then
                    local dist = distToCursor(part)
                    if dist < bestDist then
                        bestPart = part
                        bestDist = dist
                    end
                end
            end
        end
    end
    return bestPart
end

Run.RenderStepped:Connect(function()
    if not tbEnabled then return end
    local part = GetBestTargetPart()
    if part then
        task.spawn(function()
            local cap = part
            task.wait(predictionTime)
            if tbEnabled and distToCursor(cap) <= fovRadius then
                click()
            end
        end)
    end
end)


getgenv().Aimbot = {
    Status = true,
    Hitpart = 'HumanoidRootPart',
    ['Prediction'] = {
        X = 0.165,
        Y = 0.1,
    },
}

if getgenv().AimbotRan then return else getgenv().AimbotRan = true end

local Player = nil
local HoldingRightClick = false

-- Kiểm tra xem có vật cản không
local function IsObstructed(origin, targetPos)
	local raycastParams = RaycastParams.new()
	raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
	raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
	local result = Workspace:Raycast(origin, (targetPos - origin), raycastParams)
	if result and result.Instance and not result.Instance:IsDescendantOf(Player.Character) then
		return true
	end
	return false
end

-- Lấy player gần nhất hợp lệ
local function GetClosestValidPlayer()
	local closestPlayer = nil
	local shortestDistance = math.huge

	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and Config.SelectedPlayers[plr.Name] and IsValidTarget(plr) and plr.Character and plr.Character:FindFirstChild(getgenv().Aimbot.Hitpart) then
			local pos, visible = Camera:WorldToViewportPoint(plr.Character[getgenv().Aimbot.Hitpart].Position)
			if visible then
				local dist = (Vector2.new(Mouse.X, Mouse.Y) - Vector2.new(pos.X, pos.Y)).Magnitude
				if dist < shortestDistance then
					closestPlayer = plr
					shortestDistance = dist
				end
			end
		end
	end

	return closestPlayer
end

-- Bật tắt bằng chuột phải
Mouse.Button2Down:Connect(function()
	HoldingRightClick = true
	Player = GetClosestValidPlayer()
end)

Mouse.Button2Up:Connect(function()
	HoldingRightClick = false
	Player = nil
end)

-- Aimbot logic
RunService.RenderStepped:Connect(function()
	if not HoldingRightClick or not getgenv().Aimbot.Status or not Player then return end

	if not IsValidTarget(Player) then
		Player = nil
		return
	end

	local part = Player.Character:FindFirstChild(getgenv().Aimbot.Hitpart)
	if not part then return end

	local predictedPos = part.Position + part.Velocity * Vector3.new(getgenv().Aimbot.Prediction.X, getgenv().Aimbot.Prediction.Y, getgenv().Aimbot.Prediction.X)
	if IsObstructed(Camera.CFrame.Position, predictedPos) then return end

	Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPos)
end)

-- Dọn dẹp khi thoát
game:BindToClose(function()
    for _, connection in pairs(Connections) do
        pcall(function() connection:Disconnect() end)
    end
    for _, esp in pairs(ESPs) do
        pcall(function()
            esp.label:Destroy()
            esp.highlight:Destroy()
        end)
    end
    pcall(function() if ScreenGui and ScreenGui.Parent then ScreenGui:Destroy() end end)
    pcall(function() if espGui and espGui.Parent then espGui:Destroy() end end)
end)

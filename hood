local function genRandStr(len)
    local chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    local res = ""
    for i = 1, len do
        res = res .. string.sub(chars, math.random(1, #chars), math.random(1, #chars))
    end
    return res
end

local x7qZ9m = game:GetService(genRandStr(7))
local y3kP8r = game:GetService(genRandStr(9))
local w2nT6v = game:GetService(genRandStr(10))
local k4mY5t = game:GetService(genRandStr(8))
local p8vJ2x = game:GetService(genRandStr(11))
local q9rW3n = game:GetService(genRandStr(12))
local z1mH4k = game:GetService(genRandStr(6))

local t5xY9q = x7qZ9m.LocalPlayer
local r6nK7v = k4mY5t.CurrentCamera
local u2pT8m = t5xY9q:GetMouse()

local c3vJ9q = 200
local b4kM7r = 0
local d8nP5t = {}
local f2qW6y = {}

getgenv()[genRandStr(8)] = {
    Active = false,
    TargetPart = genRandStr(12),
    ChosenTargets = {},
    VisualsOn = false,
    FlightOn = false,
    FlightVel = 18,
    SpeedOn = false,
    SpeedVal = 14,
    Predict = { X = 0.165, Y = 0.1 },
    AutoFireRadius = 20,
    AutoFirePredict = 0
}

local function sendMsg(txt)
    pcall(function()
        w2nT6v:SetCore(genRandStr(12), {
            Title = genRandStr(6),
            Text = txt,
            Duration = 2
        })
    end)
end

local h7mY3x = {
    checkChar = function(plr)
        return plr and plr.Character and plr.Character:FindFirstChild(genRandStr(8)) and plr.Character:FindFirstChild(genRandStr(12))
    end,
    addConn = function(sig, cb)
        local conn = sig:Connect(cb)
        table.insert(d8nP5t, conn)
        return conn
    end,
    drawObj = function(typ, props)
        local success, obj = pcall(function()
            local d = Drawing.new(typ)
            for k, v in pairs(props) do
                d[k] = v
            end
            return d
        end)
        if not success then
            sendMsg("⚠️ " .. genRandStr(8))
            return nil
        end
        return obj
    end
}

local function checkValid(char)
    if not char then return false end
    local effects = char:FindFirstChild(genRandStr(10))
    local ko = effects and effects:FindFirstChild(genRandStr(3)) and effects[genRandStr(3)].Value
    local grabbed = char:FindFirstChild(genRandStr(15)) ~= nil
    return not (ko or grabbed)
end

local function initVisual(plr)
    if f2qW6y[plr] then
        pcall(function()
            f2qW6y[plr].rect:Remove()
            f2qW6y[plr].label:Remove()
        end)
        f2qW6y[plr] = nil
    end
    local rect = h7mY3x.drawObj("Square", {
        Visible = false,
        Color = Color3.fromRGB(200, 200, 200),
        Thickness = 1,
        Transparency = 0.7,
        Filled = false
    })
    local label = h7mY3x.drawObj("Text", {
        Visible = false,
        Color = Color3.fromRGB(200, 200, 200),
        Size = 14,
        Center = true,
        Outline = true,
        Font = Drawing.Fonts.UI,
        Text = plr.DisplayName
    })
    if rect and label then
        f2qW6y[plr] = { rect = rect, label = label }
    end
end

local function refreshVisuals()
    if not getgenv()[genRandStr(8)].VisualsOn then
        for _, draw in pairs(f2qW6y) do
            pcall(function()
                draw.rect.Visible = false
                draw.label.Visible = false
            end)
        end
        return
    end
    for _, plr in ipairs(x7qZ9m:GetPlayers()) do
        if plr ~= t5xY9q then
            if h7mY3x.checkChar(plr) then
                local char = plr.Character
                local root = char:FindFirstChild(genRandStr(12))
                local head = char:FindFirstChild(genRandStr(4))
                if root and head then
                    local headPos, visible = r6nK7v:WorldToViewportPoint(head.Position)
                    local rootPos = r6nK7v:WorldToViewportPoint(root.Position)
                    if not f2qW6y[plr] then
                        initVisual(plr)
                    end
                    if f2qW6y[plr] then
                        local draw = f2qW6y[plr]
                        local sel = getgenv()[genRandStr(8)].ChosenTargets[plr.Name]
                        draw.rect.Color = sel and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 200, 200)
                        draw.label.Color = sel and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 200, 200)
                        if visible and checkValid(char) then
                            local h = math.abs(headPos.Y - rootPos.Y) * 1.2
                            local w = h * 0.5
                            draw.rect.Size = Vector2.new(w, h)
                            draw.rect.Position = Vector2.new(rootPos.X - w / 2, rootPos.Y - h / 2)
                            draw.rect.Visible = true
                            draw.label.Position = Vector2.new(headPos.X, headPos.Y - 25)
                            draw.label.Visible = true
                        else
                            draw.rect.Visible = false
                            draw.label.Visible = false
                        end
                    end
                elseif f2qW6y[plr] then
                    pcall(function()
                        f2qW6y[plr].rect:Remove()
                        f2qW6y[plr].label:Remove()
                    end)
                    f2qW6y[plr] = nil
                end
            elseif f2qW6y[plr] then
                pcall(function()
                    f2qW6y[plr].rect:Remove()
                    f2qW6y[plr].label:Remove()
                end)
                f2qW6y[plr] = nil
            end
        end
    end
end

local function isValidPart(p)
    if not p or not p.Parent then return false end
    local char = p.Parent
    local hum = char:FindFirstChild(genRandStr(8))
    local plr = x7qZ9m:GetPlayerFromCharacter(char)
    if not hum or not plr then return false end
    return p.Name == getgenv()[genRandStr(8)].TargetPart
end

local function simClick()
    pcall(function()
        local pos = p8vJ2x:GetMouseLocation()
        local delay = math.random(300, 400) / 1000
        q9rW3n:SendMouseButtonEvent(pos.X, pos.Y, 0, true, game, 0)
        task.wait(delay)
        q9rW3n:SendMouseButtonEvent(pos.X, pos.Y, 0, false, game, 0)
    end)
end

local function findNearest()
    local best = nil
    local minDist = math.huge
    for _, plr in ipairs(x7qZ9m:GetPlayers()) do
        if plr ~= t5xY9q and plr.Character and getgenv()[genRandStr(8)].ChosenTargets[plr.Name] then
            local hum = plr.Character:FindFirstChild(genRandStr(8))
            local part = plr.Character:FindFirstChild(getgenv()[genRandStr(8)].TargetPart)
            local effects = plr.Character:FindFirstChild(genRandStr(10))
            local ko = effects and effects:FindFirstChild(genRandStr(3)) and effects[genRandStr(3)].Value
            local grabbed = plr.Character:FindFirstChild(genRandStr(15)) ~= nil
            if hum and part and not ko and not grabbed then
                local myChar = t5xY9q.Character
                local myRoot = myChar and myChar:FindFirstChild(genRandStr(12))
                if myRoot then
                    local dist = (myRoot.Position - part.Position).Magnitude
                    if dist < minDist and dist <= c3vJ9q then
                        local rayParams = RaycastParams.new()
                        rayParams.FilterType = Enum.RaycastFilterType.Blacklist
                        rayParams.FilterDescendantsInstances = {t5xY9q.Character}
                        local ray = k4mY5t:Raycast(r6nK7v.CFrame.Position, (part.Position - r6nK7v.CFrame.Position), rayParams)
                        if ray and ray.Instance:IsDescendantOf(plr.Character) then
                            best = part
                            minDist = dist
                        end
                    end
                end
            end
        end
    end
    return best
end

h7mY3x.addConn(y3kP8r.RenderStepped, function()
    local char = t5xY9q.Character
    if not char then
        getgenv()[genRandStr(8)].Active = false
        return
    end
    local hum = char:FindFirstChild(genRandStr(8))
    local effects = char:FindFirstChild(genRandStr(10))
    local ko = effects and effects:FindFirstChild(genRandStr(3)) and effects[genRandStr(3)].Value
    local grabbed = char:FindFirstChild(genRandStr(15)) ~= nil
    if not hum or ko or grabbed then
        getgenv()[genRandStr(8)].Active = false
        return
    end
    local hasTool = false
    for _, item in pairs(char:GetChildren()) do
        if item:IsA("Tool") then
            hasTool = true
            break
        end
    end
    if getgenv()[genRandStr(8)].Active and hasTool then
        local target = findNearest()
        if target then
            if getgenv()[genRandStr(8)].Active then
                local pred = target.Position + (target.Parent:FindFirstChild(getgenv()[genRandStr(8)].TargetPart).Velocity * Vector3.new(getgenv()[genRandStr(8)].Predict.X, getgenv()[genRandStr(8)].Predict.Y, getgenv()[genRandStr(8)].Predict.X))
                r6nK7v.CFrame = CFrame.new(r6nK7v.CFrame.Position, pred)
                if isValidPart(target) then
                    simClick()
                end
            end
        end
    end
end)

h7mY3x.addConn(p8vJ2x.InputBegan, function(input, proc)
    if proc then return end
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        local char = t5xY9q.Character
        if not char or not char:FindFirstChildOfClass("Tool") then return end
        local target = findNearest()
        if target then
            local dist = (r6nK7v.CFrame.Position - target.Position).Magnitude
            if dist <= c3vJ9q then
                getgenv()[genRandStr(8)].Active = true
                getgenv()[genRandStr(8)].SpeedOn = true
            end
        end
    elseif input.KeyCode == Enum.KeyCode.K then
        getgenv()[genRandStr(8)].VisualsOn = not getgenv()[genRandStr(8)].VisualsOn
        sendMsg((getgenv()[genRandStr(8)].VisualsOn and "On" or "Off") .. " " .. genRandStr(3))
    elseif input.KeyCode == Enum.KeyCode.Q then
        getgenv()[genRandStr(8)].FlightOn = not getgenv()[genRandStr(8)].FlightOn
        sendMsg("Flt: " .. (getgenv()[genRandStr(8)].FlightOn and "On" or "Off"))
    elseif input.KeyCode == Enum.KeyCode.T then
        getgenv()[genRandStr(8)].ChosenTargets = {}
        sendMsg("Cleared " .. genRandStr(8))
    elseif input.KeyCode == Enum.KeyCode.Z then
        getgenv()[genRandStr(8)].SpeedOn = not getgenv()[genRandStr(8)].SpeedOn
        sendMsg("Spd: " .. (getgenv()[genRandStr(8)].SpeedOn and "On" or "Off"))
    elseif input.UserInputType == Enum.UserInputType.MouseButton1 and p8vJ2x:IsKeyDown(Enum.KeyCode.LeftControl) then
        local tgt = u2pT8m.Target
        if not tgt then return end
        local mdl = tgt:FindFirstAncestorOfClass("Model")
        if not mdl then return end
        local plr = x7qZ9m:GetPlayerFromCharacter(mdl)
        if plr and plr ~= t5xY9q then
            local sel = getgenv()[genRandStr(8)].ChosenTargets[plr.Name]
            if sel then
                getgenv()[genRandStr(8)].ChosenTargets[plr.Name] = nil
                sendMsg("❌ " .. plr.DisplayName)
            else
                getgenv()[genRandStr(8)].ChosenTargets[plr.Name] = true
                sendMsg("✅ " .. plr.DisplayName)
            end
        end
    end
end)

h7mY3x.addConn(p8vJ2x.InputEnded, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        getgenv()[genRandStr(8)].Active = false
        getgenv()[genRandStr(8)].SpeedOn = false
    end
end)

h7mY3x.addConn(y3kP8r.RenderStepped, refreshVisuals)

h7mY3x.addConn(y3kP8r.Heartbeat, function(dt)
    if getgenv()[genRandStr(8)].SpeedOn and h7mY3x.checkChar(t5xY9q) then
        local root = t5xY9q.Character:FindFirstChild(genRandStr(12))
        local hum = t5xY9q.Character:FindFirstChild(genRandStr(8))
        local spd = getgenv()[genRandStr(8)].SpeedVal / 10
        root.CFrame = root.CFrame + hum.MoveDirection * spd
    end
    if getgenv()[genRandStr(8)].FlightOn and h7mY3x.checkChar(t5xY9q) then
        local dir = t5xY9q.Character:FindFirstChild(genRandStr(8)).MoveDirection
        local root = t5xY9q.Character:FindFirstChild(genRandStr(12))
        local vert = Vector3.new(0, p8vJ2x:IsKeyDown(Enum.KeyCode.Space) and getgenv()[genRandStr(8)].FlightVel / 10 or
            p8vJ2x:IsKeyDown(Enum.KeyCode.LeftControl) and -getgenv()[genRandStr(8)].FlightVel / 10 or 0, 0)
        root.CFrame = root.CFrame + (dir * dt * getgenv()[genRandStr(8)].FlightVel * 8)
        root.CFrame = root.CFrame + vert
        root.Velocity = root.Velocity * Vector3.new(1, 0, 1)
    end
end)

local lastState = {}

h7mY3x.addConn(y3kP8r.Heartbeat, function()
    for name, _ in pairs(getgenv()[genRandStr(8)].ChosenTargets) do
        local plr = x7qZ9m:FindFirstChild(name)
        if plr and h7mY3x.checkChar(plr) then
            local effects = plr.Character:FindFirstChild(genRandStr(10))
            local ko = effects and effects:FindFirstChild(genRandStr(3)) and effects[genRandStr(3)].Value
            if ko and not lastState[name] then
                lastState[name] = true
                sendMsg("☠️ " .. name)
            elseif not ko then
                lastState[name] = false
            end
        end
    end
end)

h7mY3x.addConn(x7qZ9m.PlayerAdded, function(plr)
    task.wait(2)
    if getgenv()[genRandStr(8)].ChosenTargets[plr.Name] then
        sendMsg(plr.Name .. " " .. genRandStr(7))
    end
    h7mY3x.addConn(plr.CharacterRemoving, function()
        if f2qW6y[plr] then
            pcall(function()
                f2qW6y[plr].rect:Remove()
                f2qW6y[plr].label:Remove()
            end)
            f2qW6y[plr] = nil
        end
    end)
end)

h7mY3x.addConn(x7qZ9m.PlayerRemoving, function(plr)
    if getgenv()[genRandStr(8)].ChosenTargets[plr.Name] then
        sendMsg(plr.Name .. " " .. genRandStr(6))
    end
    if f2qW6y[plr] then
        pcall(function()
            f2qW6y[plr].rect:Remove()
            f2qW6y[plr].label:Remove()
        end)
        f2qW6y[plr] = nil
    end
end)

h7mY3x.addConn(y3kP8r.Heartbeat, function()
    if getgenv()[genRandStr(8)].Active then
        if not b4kM7r then b4kM7r = 0 end
        if os.clock() - b4kM7r >= 50 then
            local parts = {genRandStr(4), genRandStr(12)}
            getgenv()[genRandStr(8)].TargetPart = parts[math.random(1, 2)]
            sendMsg("Part: " .. getgenv()[genRandStr(8)].TargetPart)
            b4kM7r = os.clock()
        end
    end
end)

sendMsg(genRandStr(10))
